<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.28.6">
    <meta name="project" content="Axon v0.3.0">

    <title>Converting ONNX models to Axon — Axon v0.3.0</title>
    <link rel="stylesheet" href="dist/html-elixir-5CLCQQME.css" />

    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-X7YVL3G2.js"></script>
    <script src="dist/sidebar_items-CFEF4C15.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-PLW5RNNI.js"></script>


  </head>
  <body data-type="extras" class="page-livemd">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

      <a href="Axon.html">
        <img src="assets/logo.png" alt="Axon" class="sidebar-projectImage">
      </a>

    <div class="sidebar-projectDetails">
      <a href="Axon.html" class="sidebar-projectName" translate="no">
Axon
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.3.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="settings display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/elixir-nx/axon/blob/v0.3.0/guides/serialization/onnx_to_axon.livemd#L1" title="View Source" class="view-source" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>

  <span>Converting ONNX models to Axon</span>
</h1>

  <div class="livebook-badge-container">
    <a href="#" class="livebook-badge">
      <img src="https://livebook.dev/badge/v1/blue.svg" alt="Run in Livebook" width="150" />
    </a>
  </div>

<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="1353238576-1">(</span><span class="w">
  </span><span class="p" data-group-id="1353238576-2">[</span><span class="w">
    </span><span class="p" data-group-id="1353238576-3">{</span><span class="ss">:nx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3&quot;</span><span class="p" data-group-id="1353238576-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1353238576-4">{</span><span class="ss">:axon</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.2&quot;</span><span class="p" data-group-id="1353238576-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1353238576-5">{</span><span class="ss">:exla</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3&quot;</span><span class="p" data-group-id="1353238576-5">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1353238576-6">{</span><span class="ss">:axon_onnx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.2&quot;</span><span class="p" data-group-id="1353238576-6">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1353238576-7">{</span><span class="ss">:stb_image</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.5&quot;</span><span class="p" data-group-id="1353238576-7">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1353238576-8">{</span><span class="ss">:kino</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.7.0&quot;</span><span class="p" data-group-id="1353238576-8">}</span><span class="w">
  </span><span class="p" data-group-id="1353238576-2">]</span><span class="p">,</span><span class="w">
  </span><span class="c1"># change to &quot;cuda111&quot; for Nvidia GPU</span><span class="w">
  </span><span class="ss">system_env</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1353238576-9">%{</span><span class="s">&quot;XLA_TARGET&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">xla_target</span><span class="p" data-group-id="1353238576-9">}</span><span class="w">
</span><span class="p" data-group-id="1353238576-1">)</span></code></pre><h2 id="converting-an-onnx-model-into-axon" class="section-heading">
  <a href="#converting-an-onnx-model-into-axon" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">converting-an-onnx-model-into-axon</p>
  </a>
  Converting an ONNX model into Axon
</h2>
<p>Axon is a new machine learning capability, specific to Elixir.  We would like to take
advantage of a large amount of models that have been written in other languages and
machine learning frameworks.  Let's take a look at how we could use a model developed
in another language.</p><p>Converting models developed by data scientists into a production capable implementation is a
challenge for all languages and frameworks.  <a href="https://onnx.ai/">ONNX</a> is an interchange
format that allows models written in one language or framework to be converted into
another language and framework.</p><p>The source model must use constructs mapped into ONNX.  Also, the destination framework must
support the model's ONNX constructs. From an Elixir focus, we are interested in ONNX models
that <a href="https://github.com/elixir-nx/axon_onnx">axon_onnx</a> can convert into Axon models.</p><h3 id="why-is-onnx-important-to-axon" class="section-heading">
  <a href="#why-is-onnx-important-to-axon" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">why-is-onnx-important-to-axon</p>
  </a>
  Why is ONNX important to Axon?
</h3>
<p>Elixir can get access to thousands of public models and your organization may have private models
written in other languages and frameworks.  Axon will be hard pressed to quickly repeat the
countless person-hours spent on developing models in other languages like Tensorflow and PyTorch.
However, if the model can be converted into ONNX and then into Axon, we can directly run the model
in Elixir.</p><h3 id="setting-up-our-environment" class="section-heading">
  <a href="#setting-up-our-environment" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">setting-up-our-environment</p>
  </a>
  Setting up our environment
</h3>
<p>Axon runs on top of <a href="https://hexdocs.pm/nx">Nx (Numerical Elixir)</a>. Nx has backends for
both Google's XLA (via EXLA) and PyTorch (via Torchx).  In this guide, we will use EXLA.
We'll also convert from an ONNX  model into an Axon model using
<a href="https://github.com/elixir-nx/axon_onnx"><code class="inline">axon_onnx</code></a>.</p><p>You can find all dependencies in the installation cell at the top of the notebook.
In there, you will also find the <code class="inline">XLA_TARGET</code> environment variable whick you can set
to &quot;cuda111&quot; or &quot;rocm&quot; if you have any of those GPUs available.  Let's also configure
Nx to store tensors in EXLA by default:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Nx</span><span class="o">.</span><span class="n">default_backend</span><span class="p" data-group-id="5109767759-1">(</span><span class="nc">EXLA.Backend</span><span class="p" data-group-id="5109767759-1">)</span></code></pre><p>We'll also need local access to ONNX files.  For this notebook, the models/onnx folder
contains the ONNX model file.  This notebook assumes the output file location will be
in models axon.  Copy your ONNX model files into the models/onnx folder.</p><p>This opinionated module presents a simple API for loading in an ONNX file and saving
the converted Axon model in the provided directory. This API will allow us to
save multiple models pretty quickly.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">OnnxToAxon</span><span class="w"> </span><span class="k" data-group-id="3347875185-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Helper module from ONNX to Axon.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Loads an ONNX model into Axon and saves the model

  ## Examples

      iex&gt; OnnxToAxon.onnx_axon(path_to_onnx_file, path_to_axon_dir)

  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">onnx_axon</span><span class="p" data-group-id="3347875185-2">(</span><span class="n">path_to_onnx_file</span><span class="p">,</span><span class="w"> </span><span class="n">path_to_axon_dir</span><span class="p" data-group-id="3347875185-2">)</span><span class="w"> </span><span class="k" data-group-id="3347875185-3">do</span><span class="w">
    </span><span class="n">axon_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">axon_name_from_onnx_path</span><span class="p" data-group-id="3347875185-4">(</span><span class="n">path_to_onnx_file</span><span class="p" data-group-id="3347875185-4">)</span><span class="w">
    </span><span class="n">path_to_axon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="3347875185-5">(</span><span class="n">path_to_axon_dir</span><span class="p">,</span><span class="w"> </span><span class="n">axon_name</span><span class="p" data-group-id="3347875185-5">)</span><span class="w">

    </span><span class="p" data-group-id="3347875185-6">{</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p" data-group-id="3347875185-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AxonOnnx</span><span class="o">.</span><span class="kn">import</span><span class="p" data-group-id="3347875185-7">(</span><span class="n">path_to_onnx_file</span><span class="p" data-group-id="3347875185-7">)</span><span class="w">
    </span><span class="n">model_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">serialize</span><span class="p" data-group-id="3347875185-8">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p" data-group-id="3347875185-8">)</span><span class="w">
    </span><span class="nc">File</span><span class="o">.</span><span class="n">write!</span><span class="p" data-group-id="3347875185-9">(</span><span class="n">path_to_axon</span><span class="p">,</span><span class="w"> </span><span class="n">model_bytes</span><span class="p" data-group-id="3347875185-9">)</span><span class="w">
  </span><span class="k" data-group-id="3347875185-3">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">axon_name_from_onnx_path</span><span class="p" data-group-id="3347875185-10">(</span><span class="n">onnx_path</span><span class="p" data-group-id="3347875185-10">)</span><span class="w"> </span><span class="k" data-group-id="3347875185-11">do</span><span class="w">
    </span><span class="n">model_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onnx_path</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">basename</span><span class="p" data-group-id="3347875185-12">(</span><span class="p" data-group-id="3347875185-12">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">rootname</span><span class="p" data-group-id="3347875185-13">(</span><span class="p" data-group-id="3347875185-13">)</span><span class="w">
    </span><span class="s">&quot;</span><span class="si" data-group-id="3347875185-14">#{</span><span class="n">model_root</span><span class="si" data-group-id="3347875185-14">}</span><span class="s">.axon&quot;</span><span class="w">
  </span><span class="k" data-group-id="3347875185-11">end</span><span class="w">
</span><span class="k" data-group-id="3347875185-1">end</span></code></pre><h2 id="onnx-model" class="section-heading">
  <a href="#onnx-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">onnx-model</p>
  </a>
  ONNX model
</h2>
<p>For this example, we'll use a couple ONNX models that have been saved in the Huggingface Hub.</p><p>The ONNX models were trained in Fast.ai (PyTorch) using the following notebooks:</p><ul><li><a href="https://github.com/meanderingstream/fastai_course22/blob/main/saving-a-basic-fastai-model-in-onnx.ipynb">https://github.com/meanderingstream/fastai_course22/blob/main/saving-a-basic-fastai-model-in-onnx.ipynb</a></li><li><a href="https://github.com/meanderingstream/fastai_course22/blob/main/saving-cat-dog-breed-fastai-model-in-onnx.ipynb">https://github.com/meanderingstream/fastai_course22/blob/main/saving-cat-dog-breed-fastai-model-in-onnx.ipynb</a></li></ul><p>To repeat this notebook, the onnx files for this notebook can be found on huggingface hub.  Download the onnx models from:</p><ul><li><a href="https://huggingface.co/ScottMueller/Cats_v_Dogs.ONNX">https://huggingface.co/ScottMueller/Cats_v_Dogs.ONNX</a></li><li><a href="https://huggingface.co/ScottMueller/Cat_Dog_Breeds.ONNX">https://huggingface.co/ScottMueller/Cat_Dog_Breeds.ONNX</a></li></ul><p>Download the files and place them in a directory of your choice.  By default, we will assume you downloaded them to the same directory as the notebook:</p><pre><code class="makeup elixir" translate="no"><span class="nc">File</span><span class="o">.</span><span class="n">cd!</span><span class="p" data-group-id="1292672304-1">(</span><span class="bp">__DIR__</span><span class="p" data-group-id="1292672304-1">)</span></code></pre><p>Now let's convert an ONNX model into Axon</p><pre><code class="makeup elixir" translate="no"><span class="n">path_to_onnx_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;models/onnx/cats_v_dogs.onnx&quot;</span><span class="w">
</span><span class="n">path_to_axon_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;models/axon&quot;</span><span class="w">
</span><span class="nc">OnnxToAxon</span><span class="o">.</span><span class="n">onnx_axon</span><span class="p" data-group-id="2215459685-1">(</span><span class="n">path_to_onnx_file</span><span class="p">,</span><span class="w"> </span><span class="n">path_to_axon_dir</span><span class="p" data-group-id="2215459685-1">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="n">path_to_onnx_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;models/onnx/cat_dog_breeds.onnx&quot;</span><span class="w">
</span><span class="n">path_to_axon_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;models/axon&quot;</span><span class="w">
</span><span class="nc">OnnxToAxon</span><span class="o">.</span><span class="n">onnx_axon</span><span class="p" data-group-id="2740452246-1">(</span><span class="n">path_to_onnx_file</span><span class="p">,</span><span class="w"> </span><span class="n">path_to_axon_dir</span><span class="p" data-group-id="2740452246-1">)</span></code></pre><h2 id="inference-on-onnx-derived-models" class="section-heading">
  <a href="#inference-on-onnx-derived-models" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">inference-on-onnx-derived-models</p>
  </a>
  Inference on ONNX derived models
</h2>
<p>To run inference on the model, you'll need 10 images focused on cats or dogs.  You can download the images used in training the model at:</p><p>&quot;<a href="https://s3.amazonaws.com/fast-ai-imageclas/oxford-iiit-pet.tgz%22">https://s3.amazonaws.com/fast-ai-imageclas/oxford-iiit-pet.tgz&quot;</a></p><p>Or you can find or use your own images.  In this notebook, we are going to use the local copies of the Oxford Pets dataset that was used in training the model.</p><p>Let's load the Axon model.</p><pre><code class="makeup elixir" translate="no"><span class="n">cats_v_dogs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">File</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="0129630325-1">(</span><span class="s">&quot;models/axon/cats_v_dogs.axon&quot;</span><span class="p" data-group-id="0129630325-1">)</span><span class="w">
</span><span class="p" data-group-id="0129630325-2">{</span><span class="n">cats_v_dogs_model</span><span class="p">,</span><span class="w"> </span><span class="n">cats_v_dogs_params</span><span class="p" data-group-id="0129630325-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">deserialize</span><span class="p" data-group-id="0129630325-3">(</span><span class="n">cats_v_dogs</span><span class="p" data-group-id="0129630325-3">)</span></code></pre><p>We need a tensor representation of an image.  Let's start by looking at samples of
our data.</p><pre><code class="makeup elixir" translate="no"><span class="nc">File</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="3235364128-1">(</span><span class="s">&quot;data/oxford-iiit-pet/images/havanese_71.jpg&quot;</span><span class="p" data-group-id="3235364128-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino.Image</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="3235364128-2">(</span><span class="ss">:jpeg</span><span class="p" data-group-id="3235364128-2">)</span></code></pre><p>To manipulate the images, we will use the <code class="inline">StbImage</code> library:</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="8240635782-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p" data-group-id="8240635782-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">read_file</span><span class="p" data-group-id="8240635782-2">(</span><span class="s">&quot;data/oxford-iiit-pet/images/havanese_71.jpg&quot;</span><span class="p" data-group-id="8240635782-2">)</span><span class="w">
</span><span class="p" data-group-id="8240635782-3">%</span><span class="nc" data-group-id="8240635782-3">StbImage</span><span class="p" data-group-id="8240635782-3">{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">binary</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="n">type</span><span class="p" data-group-id="8240635782-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">resize</span><span class="p" data-group-id="8240635782-4">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="mi">224</span><span class="p">,</span><span class="w"> </span><span class="mi">224</span><span class="p" data-group-id="8240635782-4">)</span></code></pre><p>Now let's work on a batch of images and convert them to tensors. Here are the images we will work with:</p><pre><code class="makeup elixir" translate="no"><span class="n">file_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6738142614-1">[</span><span class="w">
  </span><span class="s">&quot;havanese_71.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;yorkshire_terrier_9.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;Sphynx_206.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;Siamese_95.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;Egyptian_Mau_63.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;keeshond_175.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;samoyed_88.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;British_Shorthair_122.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;Russian_Blue_20.jpg&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;boxer_99.jpg&quot;</span><span class="w">
</span><span class="p" data-group-id="6738142614-1">]</span></code></pre><p>Next we resize the images:</p><pre><code class="makeup elixir" translate="no"><span class="n">resized_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="4764156296-1">(</span><span class="n">file_names</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="4764156296-2">fn</span><span class="w"> </span><span class="n">file_name</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="4764156296-3">(</span><span class="s">&quot;data/oxford-iiit-pet/images/&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">file_name</span><span class="p" data-group-id="4764156296-3">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="4764156296-4">(</span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="n">file_name</span><span class="p" data-group-id="4764156296-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">read_file!</span><span class="p" data-group-id="4764156296-5">(</span><span class="p" data-group-id="4764156296-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">resize</span><span class="p" data-group-id="4764156296-6">(</span><span class="mi">224</span><span class="p">,</span><span class="w"> </span><span class="mi">224</span><span class="p" data-group-id="4764156296-6">)</span><span class="w">
  </span><span class="k" data-group-id="4764156296-2">end</span><span class="p" data-group-id="4764156296-1">)</span></code></pre><p>And finally convert them into tensors by using <code class="inline">StbImage.to_nx/1</code>. The created tensor will have three axes, named <code class="inline">:height</code>, <code class="inline">:width</code>, and <code class="inline">:channel</code> respectively. Our goal is to stack the tensors, then normalize and transpose their axes to the order expected by the neural network:</p><pre><code class="makeup elixir" translate="no"><span class="n">img_tensors</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">resized_images</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="9939887569-1">(</span><span class="o">&amp;</span><span class="nc">StbImage</span><span class="o">.</span><span class="n">to_nx</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9939887569-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">stack</span><span class="p" data-group-id="9939887569-2">(</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="ss">:index</span><span class="p" data-group-id="9939887569-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="9939887569-3">(</span><span class="mf">255.0</span><span class="p" data-group-id="9939887569-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">transpose</span><span class="p" data-group-id="9939887569-4">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9939887569-5">[</span><span class="ss">:index</span><span class="p">,</span><span class="w"> </span><span class="ss">:channels</span><span class="p">,</span><span class="w"> </span><span class="ss">:height</span><span class="p">,</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="9939887569-5">]</span><span class="p" data-group-id="9939887569-4">)</span></code></pre><p>With our input data, it is finally time to work on predictions. First let's define a helper module:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Predictions</span><span class="w"> </span><span class="k" data-group-id="8048783636-1">do</span><span class="w">
  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  When provided a Tensor of single label predictions, returns the best vocabulary match for
  each row in the prediction tensor.

  ## Examples

      iex&gt; Predictions.sindle_label_prediction(path_to_onnx_file, path_to_axon_dir)
      [&quot;dog&quot;, &quot;cat&quot;, &quot;dog&quot;]

  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">single_label_classification</span><span class="p" data-group-id="8048783636-2">(</span><span class="n">predictions_batch</span><span class="p">,</span><span class="w"> </span><span class="n">vocabulary</span><span class="p" data-group-id="8048783636-2">)</span><span class="w"> </span><span class="k" data-group-id="8048783636-3">do</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="8048783636-4">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">shape</span><span class="p" data-group-id="8048783636-5">(</span><span class="n">predictions_batch</span><span class="p" data-group-id="8048783636-5">)</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;predictions batch shape&quot;</span><span class="p" data-group-id="8048783636-4">)</span><span class="w">

    </span><span class="k">for</span><span class="w"> </span><span class="n">prediction_tensor</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="8048783636-6">(</span><span class="n">predictions_batch</span><span class="p" data-group-id="8048783636-6">)</span><span class="w"> </span><span class="k" data-group-id="8048783636-7">do</span><span class="w">
      </span><span class="p" data-group-id="8048783636-8">{</span><span class="c">_prediction_value</span><span class="p">,</span><span class="w"> </span><span class="n">prediction_label</span><span class="p" data-group-id="8048783636-8">}</span><span class="w"> </span><span class="o">=</span><span class="w">
        </span><span class="n">prediction_tensor</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_flat_list</span><span class="p" data-group-id="8048783636-9">(</span><span class="p" data-group-id="8048783636-9">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="8048783636-10">(</span><span class="n">vocabulary</span><span class="p" data-group-id="8048783636-10">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">max</span><span class="p" data-group-id="8048783636-11">(</span><span class="p" data-group-id="8048783636-11">)</span><span class="w">

      </span><span class="n">prediction_label</span><span class="w">
    </span><span class="k" data-group-id="8048783636-7">end</span><span class="w">
  </span><span class="k" data-group-id="8048783636-3">end</span><span class="w">
</span><span class="k" data-group-id="8048783636-1">end</span></code></pre><p>Now we deserialize the model</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="7651407230-1">{</span><span class="n">cats_v_dogs_model</span><span class="p">,</span><span class="w"> </span><span class="n">cats_v_dogs_params</span><span class="p" data-group-id="7651407230-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">deserialize</span><span class="p" data-group-id="7651407230-2">(</span><span class="n">cats_v_dogs</span><span class="p" data-group-id="7651407230-2">)</span></code></pre><p>run a prediction using the <code class="inline">EXLA</code> compiler for performance</p><pre><code class="makeup elixir" translate="no"><span class="n">tensor_of_predictions</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="8615457034-1">(</span><span class="n">cats_v_dogs_model</span><span class="p">,</span><span class="w"> </span><span class="n">cats_v_dogs_params</span><span class="p">,</span><span class="w"> </span><span class="n">img_tensors</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="8615457034-1">)</span></code></pre><p>and finally retrieve the predicted label</p><pre><code class="makeup elixir" translate="no"><span class="n">dog_cat_vocabulary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3858627408-1">[</span><span class="w">
  </span><span class="s">&quot;dog&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;cat&quot;</span><span class="w">
</span><span class="p" data-group-id="3858627408-1">]</span><span class="w">

</span><span class="nc">Predictions</span><span class="o">.</span><span class="n">single_label_classification</span><span class="p" data-group-id="3858627408-2">(</span><span class="n">tensor_of_predictions</span><span class="p">,</span><span class="w"> </span><span class="n">dog_cat_vocabulary</span><span class="p" data-group-id="3858627408-2">)</span></code></pre><p>Let's repeat the above process for the dog and cat breed model.</p><pre><code class="makeup elixir" translate="no"><span class="n">cat_dog_vocabulary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3922290249-1">[</span><span class="w">
  </span><span class="s">&quot;abyssinian&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;american_bulldog&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;american_pit_bull_terrier&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;basset_hound&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;beagle&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;bengal&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;birman&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;bombay&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;boxer&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;british_shorthair&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;chihuahua&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;egyptian_mau&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;english_cocker_spaniel&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;english_setter&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;german_shorthaired&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;great_pyrenees&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;havanese&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;japanese_chin&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;keeshond&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;leonberger&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;maine_coon&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;miniature_pinscher&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;newfoundland&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;persian&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;pomeranian&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;pug&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;ragdoll&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;russian_blue&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;saint_bernard&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;samoyed&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;scottish_terrier&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;shiba_inu&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;siamese&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;sphynx&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;staffordshire_bull_terrier&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;wheaten_terrier&quot;</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;yorkshire_terrier&quot;</span><span class="w">
</span><span class="p" data-group-id="3922290249-1">]</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="n">cat_dog_breeds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">File</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="5678516329-1">(</span><span class="s">&quot;models/axon/cat_dog_breeds.axon&quot;</span><span class="p" data-group-id="5678516329-1">)</span><span class="w">
</span><span class="p" data-group-id="5678516329-2">{</span><span class="n">cat_dog_breeds_model</span><span class="p">,</span><span class="w"> </span><span class="n">cat_dog_breeds_params</span><span class="p" data-group-id="5678516329-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">deserialize</span><span class="p" data-group-id="5678516329-3">(</span><span class="n">cat_dog_breeds</span><span class="p" data-group-id="5678516329-3">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="1224658248-1">(</span><span class="n">cat_dog_breeds_model</span><span class="p">,</span><span class="w"> </span><span class="n">cat_dog_breeds_params</span><span class="p">,</span><span class="w"> </span><span class="n">img_tensors</span><span class="p" data-group-id="1224658248-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Predictions</span><span class="o">.</span><span class="n">single_label_classification</span><span class="p" data-group-id="1224658248-2">(</span><span class="n">cat_dog_vocabulary</span><span class="p" data-group-id="1224658248-2">)</span></code></pre><p>For cat and dog breeds, the model performed pretty well, but it was not perfect.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="writing_custom_event_handlers.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Writing custom event handlers
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="xor.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Modeling XOR with a neural network
        </span>
      </a>

  </div>
</div>
      <footer class="footer">

          <p>
            On Hex.pm:

            <span class="line">
              <a href="https://hex.pm/packages/axon/0.3.0" class="line footer-hex-package">Package</a>
              <a href="https://preview.hex.pm/preview/axon/0.3.0" class="line">Preview</a>

                <a href="https://preview.hex.pm/preview/axon/0.3.0/show/guides/serialization/onnx_to_axon.livemd">(current file)</a>

            </span>

            <button class="a-main line footer-button display-quick-switch">
              Search
            </button>
          </p>

        <p>
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.28.6) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>

<!-- Render math with KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js" integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    });
  });
</script>

<!-- Render diagrams with Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.3/dist/mermaid.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    mermaid.initialize({ startOnLoad: false });
    let id = 0;
    for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
        graphEl.innerHTML = svgSource;
        bindListeners && bindListeners(graphEl);
        preEl.insertAdjacentElement("afterend", graphEl);
        preEl.remove();
      });
    }
  });
</script>

  </body>
</html>
