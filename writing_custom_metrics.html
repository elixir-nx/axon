<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.31.1">
    <meta name="project" content="Axon v0.6.1">


    <title>Writing custom metrics — Axon v0.6.1</title>
    <link rel="stylesheet" href="dist/html-elixir-FM2CSD74.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-43PMFBC7.js"></script>
    <script src="dist/sidebar_items-D4AB84D3.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-L4O5OK2K.js"></script>


  </head>
  <body data-type="extras" class="page-livemd">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<div class="background-layer"></div>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="Axon.html" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Axon" />
        </a>

      <div>
        <a href="Axon.html" class="sidebar-projectName" translate="no">
Axon
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.6.1
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
Pages
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


</nav>

<main class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">
      <div class="top-search">
        <div class="search-settings">
          <form class="search-bar" action="search.html">
            <label class="search-label">
              <span class="sr-only">Search documentation of Axon</span>
              <input name="q" type="text" class="search-input" placeholder="Search Documentation (press /)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            </label>
            <button type="submit" class="search-button" aria-label="Submit Search">
              <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
            </button>
            <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
              <i class="ri-close-line ri-lg" title="Cancel search"></i>
            </button>
          </form>
          <div class="autocomplete">
          </div>
          <button class="icon-settings display-settings">
            <i class="ri-settings-3-line"></i>
            <span class="sr-only">Settings</span>
          </button>
        </div>

      </div>

<h1>

    <a href="https://github.com/elixir-nx/axon/blob/v0.6.1/guides/training_and_evaluation/writing_custom_metrics.livemd#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>Writing custom metrics</span>
</h1>

  <div class="livebook-badge-container">
    <a href="#" class="livebook-badge">
      <img src="https://livebook.dev/badge/v1/blue.svg" alt="Run in Livebook" width="150" />
    </a>
  </div>

<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="7057243645-1">(</span><span class="p" data-group-id="7057243645-2">[</span><span class="w">
  </span><span class="p" data-group-id="7057243645-3">{</span><span class="ss">:axon</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&gt;= 0.5.0&quot;</span><span class="p" data-group-id="7057243645-3">}</span><span class="w">
</span><span class="p" data-group-id="7057243645-2">]</span><span class="p" data-group-id="7057243645-1">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="ss">:ok</span></code></pre><h2 id="writing-custom-metrics" class="section-heading">
  <a href="#writing-custom-metrics" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Writing custom metrics</span>
</h2>
<p>When passing an atom to <a href="Axon.Loop.html#metric/5"><code class="inline">Axon.Loop.metric/5</code></a>, Axon dispatches the function to a built-in function in <a href="Axon.Metrics.html"><code class="inline">Axon.Metrics</code></a>. If you find you'd like to use a metric that does not exist in <a href="Axon.Metrics.html"><code class="inline">Axon.Metrics</code></a>, you can define a custom function:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">CustomMetric</span><span class="w"> </span><span class="k" data-group-id="3362811628-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="w">

  </span><span class="kd">defn</span><span class="w"> </span><span class="nf">my_weird_metric</span><span class="p" data-group-id="3362811628-2">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p" data-group-id="3362811628-2">)</span><span class="w"> </span><span class="k" data-group-id="3362811628-3">do</span><span class="w">
    </span><span class="nc">Nx</span><span class="o">.</span><span class="n">atan2</span><span class="p" data-group-id="3362811628-4">(</span><span class="n">y_true</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p" data-group-id="3362811628-4">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">sum</span><span class="p" data-group-id="3362811628-5">(</span><span class="p" data-group-id="3362811628-5">)</span><span class="w">
  </span><span class="k" data-group-id="3362811628-3">end</span><span class="w">
</span><span class="k" data-group-id="3362811628-1">end</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="0591757566-1">{</span><span class="ss">:module</span><span class="p">,</span><span class="w"> </span><span class="nc">CustomMetric</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0591757566-2">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="0591757566-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="0591757566-1">}</span></code></pre><p>Then you can pass that directly to <a href="Axon.Loop.html#metric/5"><code class="inline">Axon.Loop.metric/5</code></a>. You must provide a name for your custom metric:</p><pre><code class="makeup elixir" translate="no"><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="3932032859-1">(</span><span class="s">&quot;data&quot;</span><span class="p" data-group-id="3932032859-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3932032859-2">(</span><span class="mi">8</span><span class="p" data-group-id="3932032859-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">relu</span><span class="p" data-group-id="3932032859-3">(</span><span class="p" data-group-id="3932032859-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3932032859-4">(</span><span class="mi">4</span><span class="p" data-group-id="3932032859-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">relu</span><span class="p" data-group-id="3932032859-5">(</span><span class="p" data-group-id="3932032859-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="3932032859-6">(</span><span class="mi">1</span><span class="p" data-group-id="3932032859-6">)</span><span class="w">

</span><span class="n">loop</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="3932032859-7">(</span><span class="ss">:mean_squared_error</span><span class="p">,</span><span class="w"> </span><span class="ss">:sgd</span><span class="p" data-group-id="3932032859-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="3932032859-8">(</span><span class="o">&amp;</span><span class="nc">CustomMetric</span><span class="o">.</span><span class="n">my_weird_metric</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my weird metric&quot;</span><span class="p" data-group-id="3932032859-8">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="9094606157-1">#</span><span class="nc" data-group-id="9094606157-1">Axon.Loop</span><span class="p" data-group-id="9094606157-1">&lt;</span><span class="w">
  </span><span class="ss">metrics</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-2">%{</span><span class="w">
    </span><span class="s">&quot;loss&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9094606157-3">{</span><span class="p" data-group-id="9094606157-4">#</span><span class="nc" data-group-id="9094606157-4">Function</span><span class="p" data-group-id="9094606157-4">&lt;</span><span class="mf">11.133813849</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Metrics</span><span class="o">.</span><span class="n">running_average</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9094606157-4">&gt;</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="9094606157-5">#</span><span class="nc" data-group-id="9094606157-5">Function</span><span class="p" data-group-id="9094606157-5">&lt;</span><span class="mf">9.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_loss_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9094606157-5">&gt;</span><span class="p" data-group-id="9094606157-3">}</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;my weird metric&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9094606157-6">{</span><span class="p" data-group-id="9094606157-7">#</span><span class="nc" data-group-id="9094606157-7">Function</span><span class="p" data-group-id="9094606157-7">&lt;</span><span class="mf">11.133813849</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Metrics</span><span class="o">.</span><span class="n">running_average</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9094606157-7">&gt;</span><span class="p">,</span><span class="w">
     </span><span class="o">&amp;</span><span class="nc">CustomMetric</span><span class="o">.</span><span class="n">my_weird_metric</span><span class="o">/</span><span class="mi">2</span><span class="p" data-group-id="9094606157-6">}</span><span class="w">
  </span><span class="p" data-group-id="9094606157-2">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">handlers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-8">%{</span><span class="w">
    </span><span class="ss">completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-9">[</span><span class="p" data-group-id="9094606157-9">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-10">[</span><span class="w">
      </span><span class="p" data-group-id="9094606157-11">{</span><span class="p" data-group-id="9094606157-12">#</span><span class="nc" data-group-id="9094606157-12">Function</span><span class="p" data-group-id="9094606157-12">&lt;</span><span class="mf">27.37390314</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">log</span><span class="o">/</span><span class="mi">3</span><span class="p" data-group-id="9094606157-12">&gt;</span><span class="p">,</span><span class="w">
       </span><span class="p" data-group-id="9094606157-13">#</span><span class="nc" data-group-id="9094606157-13">Function</span><span class="p" data-group-id="9094606157-13">&lt;</span><span class="mf">6.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_filter_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9094606157-13">&gt;</span><span class="p" data-group-id="9094606157-11">}</span><span class="w">
    </span><span class="p" data-group-id="9094606157-10">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_halted</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-14">[</span><span class="p" data-group-id="9094606157-14">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-15">[</span><span class="p" data-group-id="9094606157-15">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">halted</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-16">[</span><span class="p" data-group-id="9094606157-16">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">iteration_completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-17">[</span><span class="w">
      </span><span class="p" data-group-id="9094606157-18">{</span><span class="p" data-group-id="9094606157-19">#</span><span class="nc" data-group-id="9094606157-19">Function</span><span class="p" data-group-id="9094606157-19">&lt;</span><span class="mf">27.37390314</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">log</span><span class="o">/</span><span class="mi">3</span><span class="p" data-group-id="9094606157-19">&gt;</span><span class="p">,</span><span class="w">
       </span><span class="p" data-group-id="9094606157-20">#</span><span class="nc" data-group-id="9094606157-20">Function</span><span class="p" data-group-id="9094606157-20">&lt;</span><span class="mf">64.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_filter_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9094606157-20">&gt;</span><span class="p" data-group-id="9094606157-18">}</span><span class="w">
    </span><span class="p" data-group-id="9094606157-17">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">iteration_started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-21">[</span><span class="p" data-group-id="9094606157-21">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9094606157-22">[</span><span class="p" data-group-id="9094606157-22">]</span><span class="w">
  </span><span class="p" data-group-id="9094606157-8">}</span><span class="p">,</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="p" data-group-id="9094606157-1">&gt;</span></code></pre><p>Then when running, Axon will invoke your custom metric function and accumulate it with the given aggregator:</p><pre><code class="makeup elixir" translate="no"><span class="n">train_data</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Stream</span><span class="o">.</span><span class="n">repeatedly</span><span class="p" data-group-id="0922577774-1">(</span><span class="k" data-group-id="0922577774-2">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="0922577774-3">{</span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="c">_next_key</span><span class="p" data-group-id="0922577774-3">}</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">:random</span><span class="o">.</span><span class="n">uniform</span><span class="p" data-group-id="0922577774-4">(</span><span class="mi">9999</span><span class="p" data-group-id="0922577774-4">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx.Random</span><span class="o">.</span><span class="n">key</span><span class="p" data-group-id="0922577774-5">(</span><span class="p" data-group-id="0922577774-5">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx.Random</span><span class="o">.</span><span class="n">normal</span><span class="p" data-group-id="0922577774-6">(</span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0922577774-7">{</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="0922577774-7">}</span><span class="p" data-group-id="0922577774-6">)</span><span class="w">

    </span><span class="n">ys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">sin</span><span class="p" data-group-id="0922577774-8">(</span><span class="n">xs</span><span class="p" data-group-id="0922577774-8">)</span><span class="w">
    </span><span class="p" data-group-id="0922577774-9">{</span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">ys</span><span class="p" data-group-id="0922577774-9">}</span><span class="w">
  </span><span class="k" data-group-id="0922577774-2">end</span><span class="p" data-group-id="0922577774-1">)</span><span class="w">

</span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="0922577774-10">(</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0922577774-11">%{</span><span class="p" data-group-id="0922577774-11">}</span><span class="p">,</span><span class="w"> </span><span class="ss">iterations</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="0922577774-10">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">950</span><span class="p">,</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0681635</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">weird</span><span class="w"> </span><span class="ss">metric</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mf">5.2842808</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="0305690550-1">%{</span><span class="w">
  </span><span class="s">&quot;dense_0&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-2">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-3">#</span><span class="nc" data-group-id="0305690550-3">Nx.Tensor</span><span class="p" data-group-id="0305690550-3">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="0305690550-4">[</span><span class="mi">8</span><span class="p" data-group-id="0305690550-4">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-5">[</span><span class="mf">0.0866982489824295</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4234408140182495</span><span class="p">,</span><span class="w"> </span><span class="mf">0.18205422163009644</span><span class="p">,</span><span class="w"> </span><span class="mf">0.34029239416122437</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.25770726799964905</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.07117943465709686</span><span class="p">,</span><span class="w"> </span><span class="mf">0.11470477283000946</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.027526771649718285</span><span class="p" data-group-id="0305690550-5">]</span><span class="w">
    </span><span class="p" data-group-id="0305690550-3">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-6">#</span><span class="nc" data-group-id="0305690550-6">Nx.Tensor</span><span class="p" data-group-id="0305690550-6">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="0305690550-7">[</span><span class="mi">1</span><span class="p" data-group-id="0305690550-7">]</span><span class="p" data-group-id="0305690550-8">[</span><span class="mi">8</span><span class="p" data-group-id="0305690550-8">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-9">[</span><span class="w">
        </span><span class="p" data-group-id="0305690550-10">[</span><span class="o">-</span><span class="mf">0.7088809013366699</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4486531913280487</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4666421115398407</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4163222312927246</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5076444149017334</span><span class="p">,</span><span class="w"> </span><span class="mf">0.10119977593421936</span><span class="p">,</span><span class="w"> </span><span class="mf">0.6628422141075134</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.024421442300081253</span><span class="p" data-group-id="0305690550-10">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-9">]</span><span class="w">
    </span><span class="p" data-group-id="0305690550-6">&gt;</span><span class="w">
  </span><span class="p" data-group-id="0305690550-2">}</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;dense_1&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-11">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-12">#</span><span class="nc" data-group-id="0305690550-12">Nx.Tensor</span><span class="p" data-group-id="0305690550-12">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="0305690550-13">[</span><span class="mi">4</span><span class="p" data-group-id="0305690550-13">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-14">[</span><span class="mf">0.2924745976924896</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0065560233779251575</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.21106423437595367</span><span class="p" data-group-id="0305690550-14">]</span><span class="w">
    </span><span class="p" data-group-id="0305690550-12">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-15">#</span><span class="nc" data-group-id="0305690550-15">Nx.Tensor</span><span class="p" data-group-id="0305690550-15">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="0305690550-16">[</span><span class="mi">8</span><span class="p" data-group-id="0305690550-16">]</span><span class="p" data-group-id="0305690550-17">[</span><span class="mi">4</span><span class="p" data-group-id="0305690550-17">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-18">[</span><span class="w">
        </span><span class="p" data-group-id="0305690550-19">[</span><span class="o">-</span><span class="mf">0.3407173752784729</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.6905813217163086</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5984221696853638</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.23955762386322021</span><span class="p" data-group-id="0305690550-19">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-20">[</span><span class="mf">0.42608022689819336</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5949274301528931</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.24687853455543518</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.4948572516441345</span><span class="p" data-group-id="0305690550-20">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-21">[</span><span class="mf">0.27617380023002625</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.44326621294021606</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5848686099052429</span><span class="p">,</span><span class="w"> </span><span class="mf">0.31592807173728943</span><span class="p" data-group-id="0305690550-21">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-22">[</span><span class="mf">0.5401414632797241</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.1041281446814537</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.4072037935256958</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4387882947921753</span><span class="p" data-group-id="0305690550-22">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-23">[</span><span class="o">-</span><span class="mf">0.5410752892494202</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4544697403907776</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.6238576173782349</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2077195793390274</span><span class="p" data-group-id="0305690550-23">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-24">[</span><span class="o">-</span><span class="mf">0.41753143072128296</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.11599045991897583</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.22447934746742249</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5805748701095581</span><span class="p" data-group-id="0305690550-24">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-25">[</span><span class="mf">0.1651047021150589</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.526184618473053</span><span class="p">,</span><span class="w"> </span><span class="mf">0.34729963541030884</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3307822048664093</span><span class="p" data-group-id="0305690550-25">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-26">[</span><span class="mf">0.6879482865333557</span><span class="p">,</span><span class="w"> </span><span class="mf">0.27184563875198364</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.4907835125923157</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.3555335998535156</span><span class="p" data-group-id="0305690550-26">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-18">]</span><span class="w">
    </span><span class="p" data-group-id="0305690550-15">&gt;</span><span class="w">
  </span><span class="p" data-group-id="0305690550-11">}</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;dense_2&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-27">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-28">#</span><span class="nc" data-group-id="0305690550-28">Nx.Tensor</span><span class="p" data-group-id="0305690550-28">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="0305690550-29">[</span><span class="mi">1</span><span class="p" data-group-id="0305690550-29">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-30">[</span><span class="o">-</span><span class="mf">0.8146252036094666</span><span class="p" data-group-id="0305690550-30">]</span><span class="w">
    </span><span class="p" data-group-id="0305690550-28">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0305690550-31">#</span><span class="nc" data-group-id="0305690550-31">Nx.Tensor</span><span class="p" data-group-id="0305690550-31">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="0305690550-32">[</span><span class="mi">4</span><span class="p" data-group-id="0305690550-32">]</span><span class="p" data-group-id="0305690550-33">[</span><span class="mi">1</span><span class="p" data-group-id="0305690550-33">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-34">[</span><span class="w">
        </span><span class="p" data-group-id="0305690550-35">[</span><span class="mf">1.2187021970748901</span><span class="p" data-group-id="0305690550-35">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-36">[</span><span class="mf">0.13001228868961334</span><span class="p" data-group-id="0305690550-36">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-37">[</span><span class="mf">0.2703772783279419</span><span class="p" data-group-id="0305690550-37">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="0305690550-38">[</span><span class="o">-</span><span class="mf">0.3591017723083496</span><span class="p" data-group-id="0305690550-38">]</span><span class="w">
      </span><span class="p" data-group-id="0305690550-34">]</span><span class="w">
    </span><span class="p" data-group-id="0305690550-31">&gt;</span><span class="w">
  </span><span class="p" data-group-id="0305690550-27">}</span><span class="w">
</span><span class="p" data-group-id="0305690550-1">}</span></code></pre><p>While the metric defaults are designed with supervised training loops in mind, they can be used for much more flexible purposes. By default, metrics look for the fields <code class="inline">:y_true</code> and <code class="inline">:y_pred</code> in the given loop's step state. They then apply the given metric function on those inputs. You can also define metrics which work on other fields. For example you can track the running average of a given parameter with a metric just by defining a custom output transform:</p><pre><code class="makeup elixir" translate="no"><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="7734614613-1">(</span><span class="s">&quot;data&quot;</span><span class="p" data-group-id="7734614613-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7734614613-2">(</span><span class="mi">8</span><span class="p" data-group-id="7734614613-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">relu</span><span class="p" data-group-id="7734614613-3">(</span><span class="p" data-group-id="7734614613-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7734614613-4">(</span><span class="mi">4</span><span class="p" data-group-id="7734614613-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">relu</span><span class="p" data-group-id="7734614613-5">(</span><span class="p" data-group-id="7734614613-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="7734614613-6">(</span><span class="mi">1</span><span class="p" data-group-id="7734614613-6">)</span><span class="w">

</span><span class="n">output_transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="7734614613-7">fn</span><span class="w"> </span><span class="p" data-group-id="7734614613-8">%{</span><span class="ss">model_state</span><span class="p">:</span><span class="w"> </span><span class="n">model_state</span><span class="p" data-group-id="7734614613-8">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="p" data-group-id="7734614613-9">[</span><span class="n">model_state</span><span class="p" data-group-id="7734614613-10">[</span><span class="s">&quot;dense_0&quot;</span><span class="p" data-group-id="7734614613-10">]</span><span class="p" data-group-id="7734614613-11">[</span><span class="s">&quot;kernel&quot;</span><span class="p" data-group-id="7734614613-11">]</span><span class="p" data-group-id="7734614613-9">]</span><span class="w">
</span><span class="k" data-group-id="7734614613-7">end</span><span class="w">

</span><span class="n">loop</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="7734614613-12">(</span><span class="ss">:mean_squared_error</span><span class="p">,</span><span class="w"> </span><span class="ss">:sgd</span><span class="p" data-group-id="7734614613-12">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="7734614613-13">(</span><span class="o">&amp;</span><span class="nc">Nx</span><span class="o">.</span><span class="n">mean</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dense_0_kernel_mean&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">:running_average</span><span class="p">,</span><span class="w"> </span><span class="n">output_transform</span><span class="p" data-group-id="7734614613-13">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="7734614613-14">(</span><span class="o">&amp;</span><span class="nc">Nx</span><span class="o">.</span><span class="n">variance</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dense_0_kernel_var&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">:running_average</span><span class="p">,</span><span class="w"> </span><span class="n">output_transform</span><span class="p" data-group-id="7734614613-14">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="9559770402-1">#</span><span class="nc" data-group-id="9559770402-1">Axon.Loop</span><span class="p" data-group-id="9559770402-1">&lt;</span><span class="w">
  </span><span class="ss">metrics</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-2">%{</span><span class="w">
    </span><span class="s">&quot;dense_0_kernel_mean&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9559770402-3">{</span><span class="p" data-group-id="9559770402-4">#</span><span class="nc" data-group-id="9559770402-4">Function</span><span class="p" data-group-id="9559770402-4">&lt;</span><span class="mf">11.133813849</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Metrics</span><span class="o">.</span><span class="n">running_average</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9559770402-4">&gt;</span><span class="p">,</span><span class="w">
     </span><span class="o">&amp;</span><span class="nc">Nx</span><span class="o">.</span><span class="n">mean</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9559770402-3">}</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;dense_0_kernel_var&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9559770402-5">{</span><span class="p" data-group-id="9559770402-6">#</span><span class="nc" data-group-id="9559770402-6">Function</span><span class="p" data-group-id="9559770402-6">&lt;</span><span class="mf">11.133813849</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Metrics</span><span class="o">.</span><span class="n">running_average</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9559770402-6">&gt;</span><span class="p">,</span><span class="w">
     </span><span class="o">&amp;</span><span class="nc">Nx</span><span class="o">.</span><span class="n">variance</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9559770402-5">}</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;loss&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9559770402-7">{</span><span class="p" data-group-id="9559770402-8">#</span><span class="nc" data-group-id="9559770402-8">Function</span><span class="p" data-group-id="9559770402-8">&lt;</span><span class="mf">11.133813849</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Metrics</span><span class="o">.</span><span class="n">running_average</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9559770402-8">&gt;</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="9559770402-9">#</span><span class="nc" data-group-id="9559770402-9">Function</span><span class="p" data-group-id="9559770402-9">&lt;</span><span class="mf">9.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_loss_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9559770402-9">&gt;</span><span class="p" data-group-id="9559770402-7">}</span><span class="w">
  </span><span class="p" data-group-id="9559770402-2">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">handlers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-10">%{</span><span class="w">
    </span><span class="ss">completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-11">[</span><span class="p" data-group-id="9559770402-11">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-12">[</span><span class="w">
      </span><span class="p" data-group-id="9559770402-13">{</span><span class="p" data-group-id="9559770402-14">#</span><span class="nc" data-group-id="9559770402-14">Function</span><span class="p" data-group-id="9559770402-14">&lt;</span><span class="mf">27.37390314</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">log</span><span class="o">/</span><span class="mi">3</span><span class="p" data-group-id="9559770402-14">&gt;</span><span class="p">,</span><span class="w">
       </span><span class="p" data-group-id="9559770402-15">#</span><span class="nc" data-group-id="9559770402-15">Function</span><span class="p" data-group-id="9559770402-15">&lt;</span><span class="mf">6.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_filter_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9559770402-15">&gt;</span><span class="p" data-group-id="9559770402-13">}</span><span class="w">
    </span><span class="p" data-group-id="9559770402-12">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_halted</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-16">[</span><span class="p" data-group-id="9559770402-16">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-17">[</span><span class="p" data-group-id="9559770402-17">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">halted</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-18">[</span><span class="p" data-group-id="9559770402-18">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">iteration_completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-19">[</span><span class="w">
      </span><span class="p" data-group-id="9559770402-20">{</span><span class="p" data-group-id="9559770402-21">#</span><span class="nc" data-group-id="9559770402-21">Function</span><span class="p" data-group-id="9559770402-21">&lt;</span><span class="mf">27.37390314</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">log</span><span class="o">/</span><span class="mi">3</span><span class="p" data-group-id="9559770402-21">&gt;</span><span class="p">,</span><span class="w">
       </span><span class="p" data-group-id="9559770402-22">#</span><span class="nc" data-group-id="9559770402-22">Function</span><span class="p" data-group-id="9559770402-22">&lt;</span><span class="mf">64.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_filter_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="9559770402-22">&gt;</span><span class="p" data-group-id="9559770402-20">}</span><span class="w">
    </span><span class="p" data-group-id="9559770402-19">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">iteration_started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-23">[</span><span class="p" data-group-id="9559770402-23">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9559770402-24">[</span><span class="p" data-group-id="9559770402-24">]</span><span class="w">
  </span><span class="p" data-group-id="9559770402-10">}</span><span class="p">,</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="p" data-group-id="9559770402-1">&gt;</span></code></pre><p>Axon will apply your custom output transform to the loop's step state and forward the result to your custom metric function:</p><pre><code class="makeup elixir" translate="no"><span class="n">train_data</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Stream</span><span class="o">.</span><span class="n">repeatedly</span><span class="p" data-group-id="4906486755-1">(</span><span class="k" data-group-id="4906486755-2">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="4906486755-3">{</span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="c">_next_key</span><span class="p" data-group-id="4906486755-3">}</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">:random</span><span class="o">.</span><span class="n">uniform</span><span class="p" data-group-id="4906486755-4">(</span><span class="mi">9999</span><span class="p" data-group-id="4906486755-4">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx.Random</span><span class="o">.</span><span class="n">key</span><span class="p" data-group-id="4906486755-5">(</span><span class="p" data-group-id="4906486755-5">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx.Random</span><span class="o">.</span><span class="n">normal</span><span class="p" data-group-id="4906486755-6">(</span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4906486755-7">{</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="4906486755-7">}</span><span class="p" data-group-id="4906486755-6">)</span><span class="w">

    </span><span class="n">ys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">sin</span><span class="p" data-group-id="4906486755-8">(</span><span class="n">xs</span><span class="p" data-group-id="4906486755-8">)</span><span class="w">
    </span><span class="p" data-group-id="4906486755-9">{</span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">ys</span><span class="p" data-group-id="4906486755-9">}</span><span class="w">
  </span><span class="k" data-group-id="4906486755-2">end</span><span class="p" data-group-id="4906486755-1">)</span><span class="w">

</span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="4906486755-10">(</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4906486755-11">%{</span><span class="p" data-group-id="4906486755-11">}</span><span class="p">,</span><span class="w"> </span><span class="ss">iterations</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="4906486755-10">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">950</span><span class="p">,</span><span class="w"> </span><span class="ss">dense_0_kernel_mean</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mf">0.1978206</span><span class="w"> </span><span class="ss">dense_0_kernel_var</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2699870</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0605523</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="6037311897-1">%{</span><span class="w">
  </span><span class="s">&quot;dense_0&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-2">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-3">#</span><span class="nc" data-group-id="6037311897-3">Nx.Tensor</span><span class="p" data-group-id="6037311897-3">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="6037311897-4">[</span><span class="mi">8</span><span class="p" data-group-id="6037311897-4">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-5">[</span><span class="mf">0.371105819940567</span><span class="p">,</span><span class="w"> </span><span class="mf">0.26451945304870605</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.048297226428985596</span><span class="p">,</span><span class="w"> </span><span class="mf">0.14616385102272034</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.19356133043766022</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2924956679344177</span><span class="p">,</span><span class="w"> </span><span class="mf">0.08295489847660065</span><span class="p">,</span><span class="w"> </span><span class="mf">0.25213995575904846</span><span class="p" data-group-id="6037311897-5">]</span><span class="w">
    </span><span class="p" data-group-id="6037311897-3">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-6">#</span><span class="nc" data-group-id="6037311897-6">Nx.Tensor</span><span class="p" data-group-id="6037311897-6">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="6037311897-7">[</span><span class="mi">1</span><span class="p" data-group-id="6037311897-7">]</span><span class="p" data-group-id="6037311897-8">[</span><span class="mi">8</span><span class="p" data-group-id="6037311897-8">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-9">[</span><span class="w">
        </span><span class="p" data-group-id="6037311897-10">[</span><span class="o">-</span><span class="mf">0.3888320028781891</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.39463144540786743</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5427617430686951</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.776488721370697</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2402891218662262</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.6489362716674805</span><span class="p">,</span><span class="w"> </span><span class="mf">0.772796094417572</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.3739306926727295</span><span class="p" data-group-id="6037311897-10">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-9">]</span><span class="w">
    </span><span class="p" data-group-id="6037311897-6">&gt;</span><span class="w">
  </span><span class="p" data-group-id="6037311897-2">}</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;dense_1&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-11">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-12">#</span><span class="nc" data-group-id="6037311897-12">Nx.Tensor</span><span class="p" data-group-id="6037311897-12">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="6037311897-13">[</span><span class="mi">4</span><span class="p" data-group-id="6037311897-13">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-14">[</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.006653765682131052</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3086839020252228</span><span class="p" data-group-id="6037311897-14">]</span><span class="w">
    </span><span class="p" data-group-id="6037311897-12">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-15">#</span><span class="nc" data-group-id="6037311897-15">Nx.Tensor</span><span class="p" data-group-id="6037311897-15">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="6037311897-16">[</span><span class="mi">8</span><span class="p" data-group-id="6037311897-16">]</span><span class="p" data-group-id="6037311897-17">[</span><span class="mi">4</span><span class="p" data-group-id="6037311897-17">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-18">[</span><span class="w">
        </span><span class="p" data-group-id="6037311897-19">[</span><span class="o">-</span><span class="mf">0.5556576251983643</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5547546148300171</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2708005905151367</span><span class="p">,</span><span class="w"> </span><span class="mf">0.7341570258140564</span><span class="p" data-group-id="6037311897-19">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-20">[</span><span class="o">-</span><span class="mf">0.01800161600112915</span><span class="p">,</span><span class="w"> </span><span class="mf">0.19749529659748077</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.09523773193359375</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4989740252494812</span><span class="p" data-group-id="6037311897-20">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-21">[</span><span class="o">-</span><span class="mf">0.19737857580184937</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2741832435131073</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.3699955344200134</span><span class="p">,</span><span class="w"> </span><span class="mf">0.21036939322948456</span><span class="p" data-group-id="6037311897-21">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-22">[</span><span class="o">-</span><span class="mf">0.09787613153457642</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5631319284439087</span><span class="p">,</span><span class="w"> </span><span class="mf">0.007957160472869873</span><span class="p">,</span><span class="w"> </span><span class="mf">0.23681949079036713</span><span class="p" data-group-id="6037311897-22">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-23">[</span><span class="o">-</span><span class="mf">0.469108909368515</span><span class="p">,</span><span class="w"> </span><span class="mf">0.24062377214431763</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.012939095497131348</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5055088400840759</span><span class="p" data-group-id="6037311897-23">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-24">[</span><span class="mf">0.11229842901229858</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5476430058479309</span><span class="p">,</span><span class="w"> </span><span class="mf">0.013744592666625977</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.631401538848877</span><span class="p" data-group-id="6037311897-24">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-25">[</span><span class="o">-</span><span class="mf">0.5834296941757202</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.42305096983909607</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1393480896949768</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.4647532105445862</span><span class="p" data-group-id="6037311897-25">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-26">[</span><span class="o">-</span><span class="mf">0.3684111535549164</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5147689580917358</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.3725535273551941</span><span class="p">,</span><span class="w"> </span><span class="mf">0.46682292222976685</span><span class="p" data-group-id="6037311897-26">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-18">]</span><span class="w">
    </span><span class="p" data-group-id="6037311897-15">&gt;</span><span class="w">
  </span><span class="p" data-group-id="6037311897-11">}</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;dense_2&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-27">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-28">#</span><span class="nc" data-group-id="6037311897-28">Nx.Tensor</span><span class="p" data-group-id="6037311897-28">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="6037311897-29">[</span><span class="mi">1</span><span class="p" data-group-id="6037311897-29">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-30">[</span><span class="mf">0.8305950164794922</span><span class="p" data-group-id="6037311897-30">]</span><span class="w">
    </span><span class="p" data-group-id="6037311897-28">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6037311897-31">#</span><span class="nc" data-group-id="6037311897-31">Nx.Tensor</span><span class="p" data-group-id="6037311897-31">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="6037311897-32">[</span><span class="mi">4</span><span class="p" data-group-id="6037311897-32">]</span><span class="p" data-group-id="6037311897-33">[</span><span class="mi">1</span><span class="p" data-group-id="6037311897-33">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-34">[</span><span class="w">
        </span><span class="p" data-group-id="6037311897-35">[</span><span class="mf">0.7111979722976685</span><span class="p" data-group-id="6037311897-35">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-36">[</span><span class="o">-</span><span class="mf">0.49341335892677307</span><span class="p" data-group-id="6037311897-36">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-37">[</span><span class="o">-</span><span class="mf">0.32701319456100464</span><span class="p" data-group-id="6037311897-37">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6037311897-38">[</span><span class="o">-</span><span class="mf">1.0638068914413452</span><span class="p" data-group-id="6037311897-38">]</span><span class="w">
      </span><span class="p" data-group-id="6037311897-34">]</span><span class="w">
    </span><span class="p" data-group-id="6037311897-31">&gt;</span><span class="w">
  </span><span class="p" data-group-id="6037311897-27">}</span><span class="w">
</span><span class="p" data-group-id="6037311897-1">}</span></code></pre><p>You can also define custom accumulation functions. Axon has definitions for computing running averages and running sums; however, you might find you need something like an exponential moving average:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">CustomAccumulator</span><span class="w"> </span><span class="k" data-group-id="6047472029-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="w">

  </span><span class="kd">defn</span><span class="w"> </span><span class="nf">running_ema</span><span class="p" data-group-id="6047472029-2">(</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">obs</span><span class="p">,</span><span class="w"> </span><span class="c">_i</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="6047472029-3">[</span><span class="p" data-group-id="6047472029-3">]</span><span class="p" data-group-id="6047472029-2">)</span><span class="w"> </span><span class="k" data-group-id="6047472029-4">do</span><span class="w">
    </span><span class="n">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyword!</span><span class="p" data-group-id="6047472029-5">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">alpha</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9</span><span class="p" data-group-id="6047472029-5">)</span><span class="w">
    </span><span class="n">obs</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="6047472029-6">[</span><span class="ss">:alpha</span><span class="p" data-group-id="6047472029-6">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p" data-group-id="6047472029-7">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="6047472029-8">[</span><span class="ss">:alpha</span><span class="p" data-group-id="6047472029-8">]</span><span class="p" data-group-id="6047472029-7">)</span><span class="w">
  </span><span class="k" data-group-id="6047472029-4">end</span><span class="w">
</span><span class="k" data-group-id="6047472029-1">end</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="4278127593-1">{</span><span class="ss">:module</span><span class="p">,</span><span class="w"> </span><span class="nc">CustomAccumulator</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4278127593-2">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="4278127593-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4278127593-1">}</span></code></pre><p>Your accumulator must be an arity-3 function which accepts the current accumulated value, the current observation, and the current iteration and returns the aggregated metric. You can pass a function direct as an accumulator in your metric:</p><pre><code class="makeup elixir" translate="no"><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="4746674955-1">(</span><span class="s">&quot;data&quot;</span><span class="p" data-group-id="4746674955-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4746674955-2">(</span><span class="mi">8</span><span class="p" data-group-id="4746674955-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">relu</span><span class="p" data-group-id="4746674955-3">(</span><span class="p" data-group-id="4746674955-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4746674955-4">(</span><span class="mi">4</span><span class="p" data-group-id="4746674955-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">relu</span><span class="p" data-group-id="4746674955-5">(</span><span class="p" data-group-id="4746674955-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4746674955-6">(</span><span class="mi">1</span><span class="p" data-group-id="4746674955-6">)</span><span class="w">

</span><span class="n">output_transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="4746674955-7">fn</span><span class="w"> </span><span class="p" data-group-id="4746674955-8">%{</span><span class="ss">model_state</span><span class="p">:</span><span class="w"> </span><span class="n">model_state</span><span class="p" data-group-id="4746674955-8">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="p" data-group-id="4746674955-9">[</span><span class="n">model_state</span><span class="p" data-group-id="4746674955-10">[</span><span class="s">&quot;dense_0&quot;</span><span class="p" data-group-id="4746674955-10">]</span><span class="p" data-group-id="4746674955-11">[</span><span class="s">&quot;kernel&quot;</span><span class="p" data-group-id="4746674955-11">]</span><span class="p" data-group-id="4746674955-9">]</span><span class="w">
</span><span class="k" data-group-id="4746674955-7">end</span><span class="w">

</span><span class="n">loop</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="4746674955-12">(</span><span class="ss">:mean_squared_error</span><span class="p">,</span><span class="w"> </span><span class="ss">:sgd</span><span class="p" data-group-id="4746674955-12">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="4746674955-13">(</span><span class="w">
    </span><span class="o">&amp;</span><span class="nc">Nx</span><span class="o">.</span><span class="n">mean</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;dense_0_kernel_ema_mean&quot;</span><span class="p">,</span><span class="w">
    </span><span class="o">&amp;</span><span class="nc">CustomAccumulator</span><span class="o">.</span><span class="n">running_ema</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="n">output_transform</span><span class="w">
  </span><span class="p" data-group-id="4746674955-13">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="7208568880-1">#</span><span class="nc" data-group-id="7208568880-1">Axon.Loop</span><span class="p" data-group-id="7208568880-1">&lt;</span><span class="w">
  </span><span class="ss">metrics</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-2">%{</span><span class="w">
    </span><span class="s">&quot;dense_0_kernel_ema_mean&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7208568880-3">{</span><span class="p" data-group-id="7208568880-4">#</span><span class="nc" data-group-id="7208568880-4">Function</span><span class="p" data-group-id="7208568880-4">&lt;</span><span class="mf">15.37390314</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_metric_fn</span><span class="o">/</span><span class="mi">3</span><span class="p" data-group-id="7208568880-4">&gt;</span><span class="p">,</span><span class="w">
     </span><span class="o">&amp;</span><span class="nc">Nx</span><span class="o">.</span><span class="n">mean</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="7208568880-3">}</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;loss&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7208568880-5">{</span><span class="p" data-group-id="7208568880-6">#</span><span class="nc" data-group-id="7208568880-6">Function</span><span class="p" data-group-id="7208568880-6">&lt;</span><span class="mf">11.133813849</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Metrics</span><span class="o">.</span><span class="n">running_average</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="7208568880-6">&gt;</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="7208568880-7">#</span><span class="nc" data-group-id="7208568880-7">Function</span><span class="p" data-group-id="7208568880-7">&lt;</span><span class="mf">9.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_loss_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="7208568880-7">&gt;</span><span class="p" data-group-id="7208568880-5">}</span><span class="w">
  </span><span class="p" data-group-id="7208568880-2">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">handlers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-8">%{</span><span class="w">
    </span><span class="ss">completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-9">[</span><span class="p" data-group-id="7208568880-9">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-10">[</span><span class="w">
      </span><span class="p" data-group-id="7208568880-11">{</span><span class="p" data-group-id="7208568880-12">#</span><span class="nc" data-group-id="7208568880-12">Function</span><span class="p" data-group-id="7208568880-12">&lt;</span><span class="mf">27.37390314</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">log</span><span class="o">/</span><span class="mi">3</span><span class="p" data-group-id="7208568880-12">&gt;</span><span class="p">,</span><span class="w">
       </span><span class="p" data-group-id="7208568880-13">#</span><span class="nc" data-group-id="7208568880-13">Function</span><span class="p" data-group-id="7208568880-13">&lt;</span><span class="mf">6.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_filter_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="7208568880-13">&gt;</span><span class="p" data-group-id="7208568880-11">}</span><span class="w">
    </span><span class="p" data-group-id="7208568880-10">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_halted</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-14">[</span><span class="p" data-group-id="7208568880-14">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">epoch_started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-15">[</span><span class="p" data-group-id="7208568880-15">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">halted</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-16">[</span><span class="p" data-group-id="7208568880-16">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">iteration_completed</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-17">[</span><span class="w">
      </span><span class="p" data-group-id="7208568880-18">{</span><span class="p" data-group-id="7208568880-19">#</span><span class="nc" data-group-id="7208568880-19">Function</span><span class="p" data-group-id="7208568880-19">&lt;</span><span class="mf">27.37390314</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">log</span><span class="o">/</span><span class="mi">3</span><span class="p" data-group-id="7208568880-19">&gt;</span><span class="p">,</span><span class="w">
       </span><span class="p" data-group-id="7208568880-20">#</span><span class="nc" data-group-id="7208568880-20">Function</span><span class="p" data-group-id="7208568880-20">&lt;</span><span class="mf">64.37390314</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">build_filter_fn</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="7208568880-20">&gt;</span><span class="p" data-group-id="7208568880-18">}</span><span class="w">
    </span><span class="p" data-group-id="7208568880-17">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">iteration_started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-21">[</span><span class="p" data-group-id="7208568880-21">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">started</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7208568880-22">[</span><span class="p" data-group-id="7208568880-22">]</span><span class="w">
  </span><span class="p" data-group-id="7208568880-8">}</span><span class="p">,</span><span class="w">
  </span><span class="n">...</span><span class="w">
</span><span class="p" data-group-id="7208568880-1">&gt;</span></code></pre><p>Then when you run the loop, Axon will use your custom accumulator:</p><pre><code class="makeup elixir" translate="no"><span class="n">train_data</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Stream</span><span class="o">.</span><span class="n">repeatedly</span><span class="p" data-group-id="4554531332-1">(</span><span class="k" data-group-id="4554531332-2">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="4554531332-3">{</span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="c">_next_key</span><span class="p" data-group-id="4554531332-3">}</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">:random</span><span class="o">.</span><span class="n">uniform</span><span class="p" data-group-id="4554531332-4">(</span><span class="mi">9999</span><span class="p" data-group-id="4554531332-4">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx.Random</span><span class="o">.</span><span class="n">key</span><span class="p" data-group-id="4554531332-5">(</span><span class="p" data-group-id="4554531332-5">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx.Random</span><span class="o">.</span><span class="n">normal</span><span class="p" data-group-id="4554531332-6">(</span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4554531332-7">{</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="4554531332-7">}</span><span class="p" data-group-id="4554531332-6">)</span><span class="w">

    </span><span class="n">ys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">sin</span><span class="p" data-group-id="4554531332-8">(</span><span class="n">xs</span><span class="p" data-group-id="4554531332-8">)</span><span class="w">
    </span><span class="p" data-group-id="4554531332-9">{</span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">ys</span><span class="p" data-group-id="4554531332-9">}</span><span class="w">
  </span><span class="k" data-group-id="4554531332-2">end</span><span class="p" data-group-id="4554531332-1">)</span><span class="w">

</span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="4554531332-10">(</span><span class="n">loop</span><span class="p">,</span><span class="w"> </span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4554531332-11">%{</span><span class="p" data-group-id="4554531332-11">}</span><span class="p">,</span><span class="w"> </span><span class="ss">iterations</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="4554531332-10">)</span></code></pre><pre><code class="makeup output" translate="no"><span class="ss">Epoch</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">Batch</span><span class="p">:</span><span class="w"> </span><span class="mi">950</span><span class="p">,</span><span class="w"> </span><span class="ss">dense_0_kernel_ema_mean</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mf">0.0139760</span><span class="w"> </span><span class="ss">loss</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0682910</span></code></pre><pre><code class="makeup output" translate="no"><span class="p" data-group-id="5517774505-1">%{</span><span class="w">
  </span><span class="s">&quot;dense_0&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-2">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-3">#</span><span class="nc" data-group-id="5517774505-3">Nx.Tensor</span><span class="p" data-group-id="5517774505-3">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="5517774505-4">[</span><span class="mi">8</span><span class="p" data-group-id="5517774505-4">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-5">[</span><span class="o">-</span><span class="mf">0.3344854414463043</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.14519920945167542</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1061621680855751</span><span class="p">,</span><span class="w"> </span><span class="mf">0.36911827325820923</span><span class="p">,</span><span class="w"> </span><span class="mf">0.014146199449896812</span><span class="p">,</span><span class="w"> </span><span class="mf">0.46089673042297363</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.1707312911748886</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.054649338126182556</span><span class="p" data-group-id="5517774505-5">]</span><span class="w">
    </span><span class="p" data-group-id="5517774505-3">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-6">#</span><span class="nc" data-group-id="5517774505-6">Nx.Tensor</span><span class="p" data-group-id="5517774505-6">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="5517774505-7">[</span><span class="mi">1</span><span class="p" data-group-id="5517774505-7">]</span><span class="p" data-group-id="5517774505-8">[</span><span class="mi">8</span><span class="p" data-group-id="5517774505-8">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-9">[</span><span class="w">
        </span><span class="p" data-group-id="5517774505-10">[</span><span class="mf">0.6524605751037598</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.3795280158519745</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2069108486175537</span><span class="p">,</span><span class="w"> </span><span class="mf">0.6815686821937561</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5734748840332031</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5515486001968384</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.13509605824947357</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.711794912815094</span><span class="p" data-group-id="5517774505-10">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-9">]</span><span class="w">
    </span><span class="p" data-group-id="5517774505-6">&gt;</span><span class="w">
  </span><span class="p" data-group-id="5517774505-2">}</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;dense_1&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-11">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-12">#</span><span class="nc" data-group-id="5517774505-12">Nx.Tensor</span><span class="p" data-group-id="5517774505-12">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="5517774505-13">[</span><span class="mi">4</span><span class="p" data-group-id="5517774505-13">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-14">[</span><span class="mf">0.3078235387802124</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.24773009121418</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.027328377589583397</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0769796073436737</span><span class="p" data-group-id="5517774505-14">]</span><span class="w">
    </span><span class="p" data-group-id="5517774505-12">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-15">#</span><span class="nc" data-group-id="5517774505-15">Nx.Tensor</span><span class="p" data-group-id="5517774505-15">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="5517774505-16">[</span><span class="mi">8</span><span class="p" data-group-id="5517774505-16">]</span><span class="p" data-group-id="5517774505-17">[</span><span class="mi">4</span><span class="p" data-group-id="5517774505-17">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-18">[</span><span class="w">
        </span><span class="p" data-group-id="5517774505-19">[</span><span class="o">-</span><span class="mf">0.785156786441803</span><span class="p">,</span><span class="w"> </span><span class="mf">0.07306647300720215</span><span class="p">,</span><span class="w"> </span><span class="mf">0.339533269405365</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2188076674938202</span><span class="p" data-group-id="5517774505-19">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-20">[</span><span class="mf">0.29139244556427</span><span class="p">,</span><span class="w"> </span><span class="mf">0.15977036952972412</span><span class="p">,</span><span class="w"> </span><span class="mf">0.6193944215774536</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.4305708408355713</span><span class="p" data-group-id="5517774505-20">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-21">[</span><span class="o">-</span><span class="mf">0.21063144505023956</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.3738138973712921</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.27965712547302246</span><span class="p">,</span><span class="w"> </span><span class="mf">0.051842525601387024</span><span class="p" data-group-id="5517774505-21">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-22">[</span><span class="mf">0.7297297716140747</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.08164620399475098</span><span class="p">,</span><span class="w"> </span><span class="mf">0.07651054859161377</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.43577027320861816</span><span class="p" data-group-id="5517774505-22">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-23">[</span><span class="mf">0.07917583733797073</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.27750709652900696</span><span class="p">,</span><span class="w"> </span><span class="mf">0.21028375625610352</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.6430750489234924</span><span class="p" data-group-id="5517774505-23">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-24">[</span><span class="mf">0.7177602648735046</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.2743614912033081</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.5894488096237183</span><span class="p">,</span><span class="w"> </span><span class="mf">0.634209156036377</span><span class="p" data-group-id="5517774505-24">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-25">[</span><span class="mf">0.4251592457294464</span><span class="p">,</span><span class="w"> </span><span class="mf">0.6134526133537292</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.35339266061782837</span><span class="p">,</span><span class="w"> </span><span class="mf">0.4966743588447571</span><span class="p" data-group-id="5517774505-25">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-26">[</span><span class="o">-</span><span class="mf">0.49672019481658936</span><span class="p">,</span><span class="w"> </span><span class="mf">0.46769094467163086</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.44432300329208374</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">0.3249942660331726</span><span class="p" data-group-id="5517774505-26">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-18">]</span><span class="w">
    </span><span class="p" data-group-id="5517774505-15">&gt;</span><span class="w">
  </span><span class="p" data-group-id="5517774505-11">}</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;dense_2&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-27">%{</span><span class="w">
    </span><span class="s">&quot;bias&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-28">#</span><span class="nc" data-group-id="5517774505-28">Nx.Tensor</span><span class="p" data-group-id="5517774505-28">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="5517774505-29">[</span><span class="mi">1</span><span class="p" data-group-id="5517774505-29">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-30">[</span><span class="o">-</span><span class="mf">0.8245151042938232</span><span class="p" data-group-id="5517774505-30">]</span><span class="w">
    </span><span class="p" data-group-id="5517774505-28">&gt;</span><span class="p">,</span><span class="w">
    </span><span class="s">&quot;kernel&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5517774505-31">#</span><span class="nc" data-group-id="5517774505-31">Nx.Tensor</span><span class="p" data-group-id="5517774505-31">&lt;</span><span class="w">
      </span><span class="n">f32</span><span class="p" data-group-id="5517774505-32">[</span><span class="mi">4</span><span class="p" data-group-id="5517774505-32">]</span><span class="p" data-group-id="5517774505-33">[</span><span class="mi">1</span><span class="p" data-group-id="5517774505-33">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-34">[</span><span class="w">
        </span><span class="p" data-group-id="5517774505-35">[</span><span class="mf">0.9500011205673218</span><span class="p" data-group-id="5517774505-35">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-36">[</span><span class="mf">0.9115968942642212</span><span class="p" data-group-id="5517774505-36">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-37">[</span><span class="mf">0.39282673597335815</span><span class="p" data-group-id="5517774505-37">]</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5517774505-38">[</span><span class="mf">0.19936752319335938</span><span class="p" data-group-id="5517774505-38">]</span><span class="w">
      </span><span class="p" data-group-id="5517774505-34">]</span><span class="w">
    </span><span class="p" data-group-id="5517774505-31">&gt;</span><span class="w">
  </span><span class="p" data-group-id="5517774505-27">}</span><span class="w">
</span><span class="p" data-group-id="5517774505-1">}</span></code></pre>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="custom_models_loss_optimizers.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Custom models, loss functions, and optimizers
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="writing_custom_event_handlers.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Writing custom event handlers
        </span>
      </a>

  </div>
</div>
      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/axon/0.6.1" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/axon/0.6.1">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/axon/0.6.1/show/guides/training_and_evaluation/writing_custom_metrics.livemd">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="Axon.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.31.1) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</main>
</div>

<!-- Render math with KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js" integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    });
  });
</script>

<!-- Render diagrams with Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.3/dist/mermaid.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    mermaid.initialize({ startOnLoad: false });
    let id = 0;
    for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
        graphEl.innerHTML = svgSource;
        bindListeners && bindListeners(graphEl);
        preEl.insertAdjacentElement("afterend", graphEl);
        preEl.remove();
      });
    }
  });
</script>

  </body>
</html>
