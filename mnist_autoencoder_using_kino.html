<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.31.1">
    <meta name="project" content="Axon v0.6.1">


    <title>MNIST Denoising Autoencoder using Kino for visualization — Axon v0.6.1</title>
    <link rel="stylesheet" href="dist/html-elixir-FM2CSD74.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-43PMFBC7.js"></script>
    <script src="dist/sidebar_items-D4AB84D3.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-L4O5OK2K.js"></script>


  </head>
  <body data-type="extras" class="page-livemd">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<div class="background-layer"></div>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="Axon.html" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="Axon" />
        </a>

      <div>
        <a href="Axon.html" class="sidebar-projectName" translate="no">
Axon
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.6.1
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
Pages
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


</nav>

<main class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">
      <div class="top-search">
        <div class="search-settings">
          <form class="search-bar" action="search.html">
            <label class="search-label">
              <span class="sr-only">Search documentation of Axon</span>
              <input name="q" type="text" class="search-input" placeholder="Search Documentation (press /)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            </label>
            <button type="submit" class="search-button" aria-label="Submit Search">
              <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
            </button>
            <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
              <i class="ri-close-line ri-lg" title="Cancel search"></i>
            </button>
          </form>
          <div class="autocomplete">
          </div>
          <button class="icon-settings display-settings">
            <i class="ri-settings-3-line"></i>
            <span class="sr-only">Settings</span>
          </button>
        </div>

      </div>

<h1>

    <a href="https://github.com/elixir-nx/axon/blob/v0.6.1/notebooks/generative/mnist_autoencoder_using_kino.livemd#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>MNIST Denoising Autoencoder using Kino for visualization</span>
</h1>

  <div class="livebook-badge-container">
    <a href="#" class="livebook-badge">
      <img src="https://livebook.dev/badge/v1/blue.svg" alt="Run in Livebook" width="150" />
    </a>
  </div>

<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="6095152372-1">(</span><span class="p" data-group-id="6095152372-2">[</span><span class="w">
  </span><span class="p" data-group-id="6095152372-3">{</span><span class="ss">:exla</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.4.0&quot;</span><span class="p" data-group-id="6095152372-3">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6095152372-4">{</span><span class="ss">:nx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.4.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">override</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="6095152372-4">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6095152372-5">{</span><span class="ss">:axon</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.0&quot;</span><span class="p" data-group-id="6095152372-5">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6095152372-6">{</span><span class="ss">:req</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.1&quot;</span><span class="p" data-group-id="6095152372-6">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6095152372-7">{</span><span class="ss">:kino</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.7.0&quot;</span><span class="p" data-group-id="6095152372-7">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6095152372-8">{</span><span class="ss">:scidata</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.1.9&quot;</span><span class="p" data-group-id="6095152372-8">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6095152372-9">{</span><span class="ss">:stb_image</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.5.2&quot;</span><span class="p" data-group-id="6095152372-9">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="6095152372-10">{</span><span class="ss">:table_rex</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 3.1.1&quot;</span><span class="p" data-group-id="6095152372-10">}</span><span class="w">
</span><span class="p" data-group-id="6095152372-2">]</span><span class="p" data-group-id="6095152372-1">)</span></code></pre><h2 id="introduction" class="section-heading">
  <a href="#introduction" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Introduction</span>
</h2>
<p>The goal of this notebook is to build a Denoising Autoencoder from scratch using Livebook. This notebook is based on <a href="fashionmnist_autoencoder.html">Training an Autoencoder on Fashion MNIST</a>, but includes some tips on using Livebook to train the model and using <a href="https://hexdocs.pm/kino/Kino.html">Kino</a> (Livebook's interactive widget library) to play with and visualize our results.</p><h2 id="data-loading" class="section-heading">
  <a href="#data-loading" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Data loading</span>
</h2>
<p>An autoencoder learns to recreate data it's seen in the dataset. For this notebook, we're going to try something simple: generating images of digits using the MNIST digit recognition dataset.</p><!-- livebook:{"break_markdown":true} --><p>Following along with the <a href="fashionmnist_autoencoder.html">Fashion MNIST Autoencoder example</a>, we'll use <a href="https://github.com/elixir-nx/scidata">Scidata</a> to download the MNIST dataset and then preprocess the data.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># We&#39;re not going to use the labels so we&#39;ll ignore them</span><span class="w">
</span><span class="p" data-group-id="0831947843-1">{</span><span class="n">train_images</span><span class="p">,</span><span class="w"> </span><span class="c">_train_labels</span><span class="p" data-group-id="0831947843-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Scidata.MNIST</span><span class="o">.</span><span class="n">download</span><span class="p" data-group-id="0831947843-2">(</span><span class="p" data-group-id="0831947843-2">)</span><span class="w">
</span><span class="p" data-group-id="0831947843-3">{</span><span class="n">train_images_binary</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="p" data-group-id="0831947843-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">train_images</span></code></pre><p>The <code class="inline">shape</code> tells us we have 60,000 images with a single channel of size 28x28.</p><p>According to <a href="http://yann.lecun.com/exdb/mnist/">the MNIST website</a>:</p><blockquote><p>Pixels are organized row-wise. Pixel values are 0 to 255. 0 means background (white), 255 means foreground (black).</p></blockquote><p>Let's preprocess and normalize the data accordingly.</p><pre><code class="makeup elixir" translate="no"><span class="n">train_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">train_images_binary</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">from_binary</span><span class="p" data-group-id="2044410646-1">(</span><span class="n">type</span><span class="p" data-group-id="2044410646-1">)</span><span class="w">
  </span><span class="c1"># Since pixels are organized row-wise, reshape into rows x columns</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="2044410646-2">(</span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="ss">names</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2044410646-3">[</span><span class="ss">:images</span><span class="p">,</span><span class="w"> </span><span class="ss">:channels</span><span class="p">,</span><span class="w"> </span><span class="ss">:height</span><span class="p">,</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="2044410646-3">]</span><span class="p" data-group-id="2044410646-2">)</span><span class="w">
  </span><span class="c1"># Normalize the pixel values to be between 0 and 1</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="2044410646-4">(</span><span class="mi">255</span><span class="p" data-group-id="2044410646-4">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># Make sure they look like numbers</span><span class="w">
</span><span class="n">train_images</span><span class="p" data-group-id="9016507022-1">[</span><span class="p" data-group-id="9016507022-2">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p" data-group-id="9016507022-2">]</span><span class="p" data-group-id="9016507022-1">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_heatmap</span><span class="p" data-group-id="9016507022-3">(</span><span class="p" data-group-id="9016507022-3">)</span></code></pre><p>That looks right! Let's repeat the process for the test set.</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="5401704867-1">{</span><span class="n">test_images</span><span class="p">,</span><span class="w"> </span><span class="c">_train_labels</span><span class="p" data-group-id="5401704867-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Scidata.MNIST</span><span class="o">.</span><span class="n">download_test</span><span class="p" data-group-id="5401704867-2">(</span><span class="p" data-group-id="5401704867-2">)</span><span class="w">
</span><span class="p" data-group-id="5401704867-3">{</span><span class="n">test_images_binary</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">shape</span><span class="p" data-group-id="5401704867-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_images</span><span class="w">

</span><span class="n">test_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">test_images_binary</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">from_binary</span><span class="p" data-group-id="5401704867-4">(</span><span class="n">type</span><span class="p" data-group-id="5401704867-4">)</span><span class="w">
  </span><span class="c1"># Since pixels are organized row-wise, reshape into rows x columns</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="5401704867-5">(</span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="ss">names</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5401704867-6">[</span><span class="ss">:images</span><span class="p">,</span><span class="w"> </span><span class="ss">:channels</span><span class="p">,</span><span class="w"> </span><span class="ss">:height</span><span class="p">,</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="5401704867-6">]</span><span class="p" data-group-id="5401704867-5">)</span><span class="w">
  </span><span class="c1"># Normalize the pixel values to be between 0 and 1</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="5401704867-7">(</span><span class="mi">255</span><span class="p" data-group-id="5401704867-7">)</span><span class="w">

</span><span class="n">test_images</span><span class="p" data-group-id="5401704867-8">[</span><span class="p" data-group-id="5401704867-9">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p" data-group-id="5401704867-9">]</span><span class="p" data-group-id="5401704867-8">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_heatmap</span><span class="p" data-group-id="5401704867-10">(</span><span class="p" data-group-id="5401704867-10">)</span></code></pre><h2 id="building-the-model" class="section-heading">
  <a href="#building-the-model" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Building the model</span>
</h2>
<p>An autoencoder is a a network that has the same sized input as output, with a &quot;bottleneck&quot; layer in the middle with far fewer parameters than the input. Its goal is to force the output to reconstruct the input. The bottleneck layer forces the network to learn a compressed representation of the input space.</p><p>A <em>denoising</em> autoencoder is a small tweak on an autoencoder that takes a corrupted input (often corrupted by adding noise or zeroing out pixels) and reconstructs the original input, removing the noise in the process.</p><p>The part of the autoencoder that takes the input and compresses it into the bottleneck layer is called the <em>encoder</em> and the part that takes the compressed representation and reconstructs the input is called the <em>decoder</em>. Usually the decoder mirrors the encoder.</p><p>MNIST is a pretty easy dataset, so we're going to try a fairly small autoencoder.</p><p>The input image has size 784 (28 rows <em> 28 cols </em> 1 pixel). We'll set up the encoder to turn that into 256 features, then 128, 64, and then 10 features for the bottleneck layer. The decoder will do the reverse, take the 10 features and go to 64, 128, 256 and 784. I'll use fully-connected (dense) layers.</p><!-- livebook:{"break_markdown":true} --><h3 id="the-model" class="section-heading">
  <a href="#the-model" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">The model</span>
</h3>
<pre><code class="makeup elixir" translate="no"><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="4587841276-1">(</span><span class="s">&quot;image&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4587841276-2">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="4587841276-2">}</span><span class="p" data-group-id="4587841276-1">)</span><span class="w">
  </span><span class="c1"># This is now 28*28*1 = 784</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">flatten</span><span class="p" data-group-id="4587841276-3">(</span><span class="p" data-group-id="4587841276-3">)</span><span class="w">
  </span><span class="c1"># The encoder</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4587841276-4">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4587841276-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4587841276-5">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4587841276-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4587841276-6">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4587841276-6">)</span><span class="w">
  </span><span class="c1"># Bottleneck layer</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4587841276-7">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4587841276-7">)</span><span class="w">
  </span><span class="c1"># The decoder</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4587841276-8">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4587841276-8">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4587841276-9">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4587841276-9">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4587841276-10">(</span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4587841276-10">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4587841276-11">(</span><span class="mi">784</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:sigmoid</span><span class="p" data-group-id="4587841276-11">)</span><span class="w">
  </span><span class="c1"># Turn it back into a 28x28 single channel image</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">reshape</span><span class="p" data-group-id="4587841276-12">(</span><span class="p" data-group-id="4587841276-13">{</span><span class="ss">:auto</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="4587841276-13">}</span><span class="p" data-group-id="4587841276-12">)</span><span class="w">

</span><span class="c1"># We can use Axon.Display to show us what each of the layers would look like</span><span class="w">
</span><span class="c1"># assuming we send in a batch of 4 images</span><span class="w">
</span><span class="nc">Axon.Display</span><span class="o">.</span><span class="n">as_table</span><span class="p" data-group-id="4587841276-14">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">template</span><span class="p" data-group-id="4587841276-15">(</span><span class="p" data-group-id="4587841276-16">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p" data-group-id="4587841276-16">}</span><span class="p">,</span><span class="w"> </span><span class="ss">:f32</span><span class="p" data-group-id="4587841276-15">)</span><span class="p" data-group-id="4587841276-14">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="4587841276-17">(</span><span class="p" data-group-id="4587841276-17">)</span></code></pre><p>Checking our understanding, since the layers are all dense layers, the number of parameters should be <code class="inline">input_features * output_features</code> parameters for the weights + <code class="inline">output_features</code> parameters for the biases for each layer.</p><p>This should match the <code class="inline">Total Parameters</code> output from Axon.Display (486298 parameters)</p><pre><code class="makeup elixir" translate="no"><span class="c1"># encoder</span><span class="w">
</span><span class="n">encoder_parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">784</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p" data-group-id="7640927312-1">(</span><span class="mi">256</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="p" data-group-id="7640927312-1">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p" data-group-id="7640927312-2">(</span><span class="mi">128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">64</span><span class="p" data-group-id="7640927312-2">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p" data-group-id="7640927312-3">(</span><span class="mi">64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="7640927312-3">)</span><span class="w">
</span><span class="n">decoder_parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p" data-group-id="7640927312-4">(</span><span class="mi">64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="p" data-group-id="7640927312-4">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p" data-group-id="7640927312-5">(</span><span class="mi">128</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">256</span><span class="p" data-group-id="7640927312-5">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p" data-group-id="7640927312-6">(</span><span class="mi">256</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">784</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">784</span><span class="p" data-group-id="7640927312-6">)</span><span class="w">
</span><span class="n">total_parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encoder_parameters</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">decoder_parameters</span></code></pre><h3 id="training" class="section-heading">
  <a href="#training" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Training</span>
</h3>
<p>With the model set up, we can now try to train the model. We'll use MSE loss to compare our reconstruction with the original</p><!-- livebook:{"break_markdown":true} --><p>We'll create the training input by turning our image list into batches of size 128 and then using the same image as both the input and the target. However, the input image will have noise added to it that the autoencoder will have to remove.</p><p>For validation data, we'll use the test set and look at how the autoencoder does at reconstructing the test set to make sure we're not overfitting</p><!-- livebook:{"break_markdown":true} --><p>The function below adds some noise to the image by adding the image with gaussian noise scaled by a noise factor. We then have to make sure the pixel values are still within the 0..1.0 range.</p><p>We have to define this function using <code class="inline">defn</code> so that <a href="https://hexdocs.pm/nx/0.7.0/Nx.html"><code class="inline">Nx</code></a> can optimize it. If we don't do this, adding noise will take a really long time, making our training loop very slow. See <a href="https://hexdocs.pm/nx/Nx.Defn.html">Nx.defn</a> for more details. <code class="inline">defn</code> can only be used in a module so we'll define a little module to contain it.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Noiser</span><span class="w"> </span><span class="k" data-group-id="8853530305-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="w">

  </span><span class="na">@noise_factor</span><span class="w"> </span><span class="mf">0.4</span><span class="w">

  </span><span class="kd">defn</span><span class="w"> </span><span class="nf">add_noise</span><span class="p" data-group-id="8853530305-2">(</span><span class="n">images</span><span class="p" data-group-id="8853530305-2">)</span><span class="w"> </span><span class="k" data-group-id="8853530305-3">do</span><span class="w">
    </span><span class="na">@noise_factor</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">multiply</span><span class="p" data-group-id="8853530305-4">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">random_normal</span><span class="p" data-group-id="8853530305-5">(</span><span class="n">images</span><span class="p" data-group-id="8853530305-5">)</span><span class="p" data-group-id="8853530305-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">add</span><span class="p" data-group-id="8853530305-6">(</span><span class="n">images</span><span class="p" data-group-id="8853530305-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">clip</span><span class="p" data-group-id="8853530305-7">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p" data-group-id="8853530305-7">)</span><span class="w">
  </span><span class="k" data-group-id="8853530305-3">end</span><span class="w">
</span><span class="k" data-group-id="8853530305-1">end</span><span class="w">

</span><span class="n">add_noise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="o">.</span><span class="n">jit</span><span class="p" data-group-id="8853530305-8">(</span><span class="o">&amp;</span><span class="nc">Noiser</span><span class="o">.</span><span class="n">add_noise</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="8853530305-8">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="w">

</span><span class="c1"># The original image which is the target the network will trying to match</span><span class="w">
</span><span class="n">batched_train_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">train_images</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="3334719904-1">(</span><span class="n">batch_size</span><span class="p" data-group-id="3334719904-1">)</span><span class="w">

</span><span class="n">batched_noisy_train_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">train_images</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="3334719904-2">(</span><span class="n">batch_size</span><span class="p" data-group-id="3334719904-2">)</span><span class="w">
  </span><span class="c1"># goes after to_batched so the noise is different every time</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="3334719904-3">(</span><span class="n">add_noise</span><span class="p" data-group-id="3334719904-3">)</span><span class="w">

</span><span class="c1"># The noisy image is the input to the network</span><span class="w">
</span><span class="c1"># and the original image is the target it&#39;s trying to match</span><span class="w">
</span><span class="n">train_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="3334719904-4">(</span><span class="n">batched_noisy_train_images</span><span class="p">,</span><span class="w"> </span><span class="n">batched_train_images</span><span class="p" data-group-id="3334719904-4">)</span><span class="w">

</span><span class="n">batched_test_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">test_images</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="3334719904-5">(</span><span class="n">batch_size</span><span class="p" data-group-id="3334719904-5">)</span><span class="w">

</span><span class="n">batched_noisy_test_images</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">test_images</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_batched</span><span class="p" data-group-id="3334719904-6">(</span><span class="n">batch_size</span><span class="p" data-group-id="3334719904-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="3334719904-7">(</span><span class="n">add_noise</span><span class="p" data-group-id="3334719904-7">)</span><span class="w">

</span><span class="n">test_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">zip</span><span class="p" data-group-id="3334719904-8">(</span><span class="n">batched_noisy_test_images</span><span class="p">,</span><span class="w"> </span><span class="n">batched_test_images</span><span class="p" data-group-id="3334719904-8">)</span></code></pre><p>Let's see what an element of the input and target look like</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="1967877682-1">{</span><span class="n">input_batch</span><span class="p">,</span><span class="w"> </span><span class="n">target_batch</span><span class="p" data-group-id="1967877682-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">at</span><span class="p" data-group-id="1967877682-2">(</span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1967877682-2">)</span><span class="w">
</span><span class="p" data-group-id="1967877682-3">{</span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_heatmap</span><span class="p" data-group-id="1967877682-4">(</span><span class="n">input_batch</span><span class="p" data-group-id="1967877682-5">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1967877682-5">]</span><span class="p" data-group-id="1967877682-4">)</span><span class="p">,</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_heatmap</span><span class="p" data-group-id="1967877682-6">(</span><span class="n">target_batch</span><span class="p" data-group-id="1967877682-7">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1967877682-7">]</span><span class="p" data-group-id="1967877682-6">)</span><span class="p" data-group-id="1967877682-3">}</span></code></pre><p>Looks right (and tricky). Let's see how the model does.</p><pre><code class="makeup elixir" translate="no"><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="2250159244-1">(</span><span class="ss">:mean_squared_error</span><span class="p">,</span><span class="w"> </span><span class="nc">Polaris.Optimizers</span><span class="o">.</span><span class="n">adamw</span><span class="p" data-group-id="2250159244-2">(</span><span class="ss">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.001</span><span class="p" data-group-id="2250159244-2">)</span><span class="p" data-group-id="2250159244-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">validate</span><span class="p" data-group-id="2250159244-3">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">test_data</span><span class="p" data-group-id="2250159244-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="2250159244-4">(</span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2250159244-5">%{</span><span class="p" data-group-id="2250159244-5">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="2250159244-4">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><p>Now that we have a model that theoretically has learned <em>something</em>, we'll see what it's learned by running it on some images from the test set. We'll use Kino to allow us to select the image from the test set to run the model against. To avoid losing the params that took a while to train, we'll create another branch so we can experiment with the params and stop execution when needed without having to retrain.</p><!-- livebook:{"branch_parent_index":2} --><h2 id="evaluation" class="section-heading">
  <a href="#evaluation" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Evaluation</span>
</h2>
<p><strong>A note on branching</strong></p><p>By default, everything in Livebook runs sequentially in a single process. Stopping a running cell aborts that process and consequently all its state is lost. A <strong>branching section</strong> copies everything from its parent and runs in a separate process. Thanks to this <strong>isolation</strong>, when we stop a cell in a branching section, only the state within that section is gone.</p><p>Since we just spent a bunch of time training the model and don't want to lose that memory state as we continue to experiment, we create a branching section. This does add some memory overhead, but it's worth it so we can experiment without fear!</p><!-- livebook:{"break_markdown":true} --><p>To use <a href="https://hexdocs.pm/kino/0.12.3/Kino.html"><code class="inline">Kino</code></a> to give us an interactive tool to evaluate the model, we'll create a <a href="https://hexdocs.pm/kino/0.12.3/Kino.Frame.html"><code class="inline">Kino.Frame</code></a> that we can dynamically update. We'll also create a form using <a href="https://hexdocs.pm/kino/0.12.3/Kino.Control.html"><code class="inline">Kino.Control</code></a> to allow the user to select which image from the test set they'd like to evaluate the model on. Finally <code class="inline">Kino.Control.stream</code> enables us to respond to changes in the user's selection when the user clicks the &quot;Render&quot; button.</p><p>We can use <code class="inline">Nx.concatenate</code> to stack the images side by side for a prettier output.</p><pre><code class="makeup elixir" translate="no"><span class="n">form</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Kino.Control</span><span class="o">.</span><span class="n">form</span><span class="p" data-group-id="7852211206-1">(</span><span class="w">
    </span><span class="p" data-group-id="7852211206-2">[</span><span class="w">
      </span><span class="ss">test_image_index</span><span class="p">:</span><span class="w"> </span><span class="nc">Kino.Input</span><span class="o">.</span><span class="n">number</span><span class="p" data-group-id="7852211206-3">(</span><span class="s">&quot;Test Image Index&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">default</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="7852211206-3">)</span><span class="w">
    </span><span class="p" data-group-id="7852211206-2">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">submit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Render&quot;</span><span class="w">
  </span><span class="p" data-group-id="7852211206-1">)</span><span class="w">

</span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="7852211206-4">(</span><span class="n">form</span><span class="p" data-group-id="7852211206-4">)</span><span class="w">

</span><span class="n">form</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino.Control</span><span class="o">.</span><span class="n">stream</span><span class="p" data-group-id="7852211206-5">(</span><span class="p" data-group-id="7852211206-5">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">animate</span><span class="p" data-group-id="7852211206-6">(</span><span class="k" data-group-id="7852211206-7">fn</span><span class="w"> </span><span class="p" data-group-id="7852211206-8">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7852211206-9">%{</span><span class="ss">test_image_index</span><span class="p">:</span><span class="w"> </span><span class="n">image_index</span><span class="p" data-group-id="7852211206-9">}</span><span class="p" data-group-id="7852211206-8">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">test_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_images</span><span class="p" data-group-id="7852211206-10">[</span><span class="p" data-group-id="7852211206-11">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="n">image_index</span><span class="p" data-group-id="7852211206-11">]</span><span class="p" data-group-id="7852211206-10">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">add_noise</span><span class="o">.</span><span class="p" data-group-id="7852211206-12">(</span><span class="p" data-group-id="7852211206-12">)</span><span class="w">

  </span><span class="n">reconstructed_image</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="n">model</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="7852211206-13">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">test_image</span><span class="p" data-group-id="7852211206-13">)</span><span class="w">
    </span><span class="c1"># Get rid of the batch dimension</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">squeeze</span><span class="p" data-group-id="7852211206-14">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7852211206-15">[</span><span class="mi">0</span><span class="p" data-group-id="7852211206-15">]</span><span class="p" data-group-id="7852211206-14">)</span><span class="w">

  </span><span class="n">combined_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">concatenate</span><span class="p" data-group-id="7852211206-16">(</span><span class="p" data-group-id="7852211206-17">[</span><span class="n">test_image</span><span class="p">,</span><span class="w"> </span><span class="n">reconstructed_image</span><span class="p" data-group-id="7852211206-17">]</span><span class="p">,</span><span class="w"> </span><span class="ss">axis</span><span class="p">:</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="7852211206-16">)</span><span class="w">
  </span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_heatmap</span><span class="p" data-group-id="7852211206-18">(</span><span class="n">combined_image</span><span class="p" data-group-id="7852211206-18">)</span><span class="w">
</span><span class="k" data-group-id="7852211206-7">end</span><span class="p" data-group-id="7852211206-6">)</span></code></pre><p>That looks pretty good!</p><p>Note we used <a href="https://hexdocs.pm/kino/0.12.3/Kino.html#animate/2"><code class="inline">Kino.animate/2</code></a> which runs asynchronously so we don't block execution of the rest of the notebook.</p><!-- livebook:{"branch_parent_index":2} --><h2 id="a-better-training-loop" class="section-heading">
  <a href="#a-better-training-loop" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">A better training loop</span>
</h2>
<p><em>Note that we branch from the &quot;Building a model&quot; section since we only need the model definition for this section and not the previously trained model.</em></p><!-- livebook:{"break_markdown":true} --><p>It'd be nice to see how the model improves as it trains. In this section (also a branch since I plan to experiment and don't want to lose the execution state) we'll improve the training loop to use <a href="https://hexdocs.pm/kino/0.12.3/Kino.html"><code class="inline">Kino</code></a> to show us how it's doing.</p><p><a href="https://hexdocs.pm/axon/Axon.Loop.html#handle/4">Axon.Loop.handle</a> gives us a hook into various points of the training loop. We'll can use it with the <code class="inline">:iteration_completed</code> event to get a copy of the state of the params after some number of completed iterations of the training loop. By using those params to render an image in the test set, we can get a live view of the autoencoder learning to reconstruct its inputs.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># A helper function to display the input and output side by side</span><span class="w">
</span><span class="n">combined_input_output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="3874490705-1">fn</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">image_index</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">test_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_images</span><span class="p" data-group-id="3874490705-2">[</span><span class="p" data-group-id="3874490705-3">[</span><span class="ss">images</span><span class="p">:</span><span class="w"> </span><span class="n">image_index</span><span class="p" data-group-id="3874490705-3">]</span><span class="p" data-group-id="3874490705-2">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">add_noise</span><span class="o">.</span><span class="p" data-group-id="3874490705-4">(</span><span class="p" data-group-id="3874490705-4">)</span><span class="w">
  </span><span class="n">reconstructed_image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="3874490705-5">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">test_image</span><span class="p" data-group-id="3874490705-5">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">squeeze</span><span class="p" data-group-id="3874490705-6">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3874490705-7">[</span><span class="mi">0</span><span class="p" data-group-id="3874490705-7">]</span><span class="p" data-group-id="3874490705-6">)</span><span class="w">
  </span><span class="nc">Nx</span><span class="o">.</span><span class="n">concatenate</span><span class="p" data-group-id="3874490705-8">(</span><span class="p" data-group-id="3874490705-9">[</span><span class="n">test_image</span><span class="p">,</span><span class="w"> </span><span class="n">reconstructed_image</span><span class="p" data-group-id="3874490705-9">]</span><span class="p">,</span><span class="w"> </span><span class="ss">axis</span><span class="p">:</span><span class="w"> </span><span class="ss">:width</span><span class="p" data-group-id="3874490705-8">)</span><span class="w">
</span><span class="k" data-group-id="3874490705-1">end</span><span class="w">

</span><span class="nc">Nx</span><span class="o">.</span><span class="n">to_heatmap</span><span class="p" data-group-id="3874490705-10">(</span><span class="n">combined_input_output</span><span class="o">.</span><span class="p" data-group-id="3874490705-11">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="3874490705-11">)</span><span class="p" data-group-id="3874490705-10">)</span></code></pre><p>It'd also be nice to have a prettier version of the output. Let's convert the heatmap to a png to make that happen.</p><pre><code class="makeup elixir" translate="no"><span class="n">image_to_kino</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="6348918852-1">fn</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">image</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">multiply</span><span class="p" data-group-id="6348918852-2">(</span><span class="mi">255</span><span class="p" data-group-id="6348918852-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">as_type</span><span class="p" data-group-id="6348918852-3">(</span><span class="ss">:u8</span><span class="p" data-group-id="6348918852-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">transpose</span><span class="p" data-group-id="6348918852-4">(</span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6348918852-5">[</span><span class="ss">:height</span><span class="p">,</span><span class="w"> </span><span class="ss">:width</span><span class="p">,</span><span class="w"> </span><span class="ss">:channels</span><span class="p" data-group-id="6348918852-5">]</span><span class="p" data-group-id="6348918852-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">from_nx</span><span class="p" data-group-id="6348918852-6">(</span><span class="p" data-group-id="6348918852-6">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">resize</span><span class="p" data-group-id="6348918852-7">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p" data-group-id="6348918852-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">to_binary</span><span class="p" data-group-id="6348918852-8">(</span><span class="ss">:png</span><span class="p" data-group-id="6348918852-8">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino.Image</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="6348918852-9">(</span><span class="ss">:png</span><span class="p" data-group-id="6348918852-9">)</span><span class="w">
</span><span class="k" data-group-id="6348918852-1">end</span><span class="w">

</span><span class="n">image_to_kino</span><span class="o">.</span><span class="p" data-group-id="6348918852-10">(</span><span class="n">combined_input_output</span><span class="o">.</span><span class="p" data-group-id="6348918852-11">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="6348918852-11">)</span><span class="p" data-group-id="6348918852-10">)</span></code></pre><p>Much nicer!</p><p>Once again we'll use <a href="https://hexdocs.pm/kino/0.12.3/Kino.Frame.html"><code class="inline">Kino.Frame</code></a> for dynamically updating output:</p><pre><code class="makeup elixir" translate="no"><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="0331108351-1">(</span><span class="p" data-group-id="0331108351-1">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="0331108351-2">(</span><span class="p" data-group-id="0331108351-2">)</span><span class="w">

</span><span class="n">render_example_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="0331108351-3">fn</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">append</span><span class="p" data-group-id="0331108351-4">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Epoch: </span><span class="si" data-group-id="0331108351-5">#{</span><span class="n">state</span><span class="o">.</span><span class="n">epoch</span><span class="si" data-group-id="0331108351-5">}</span><span class="s">, Iteration: </span><span class="si" data-group-id="0331108351-6">#{</span><span class="n">state</span><span class="o">.</span><span class="n">iteration</span><span class="si" data-group-id="0331108351-6">}</span><span class="s">&quot;</span><span class="p" data-group-id="0331108351-4">)</span><span class="w">
  </span><span class="c1"># state.step_state[:model_state] contains the model params when this event is fired</span><span class="w">
  </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">step_state</span><span class="p" data-group-id="0331108351-7">[</span><span class="ss">:model_state</span><span class="p" data-group-id="0331108351-7">]</span><span class="w">
  </span><span class="n">image_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">random</span><span class="p" data-group-id="0331108351-8">(</span><span class="mi">0</span><span class="o">..</span><span class="p" data-group-id="0331108351-9">(</span><span class="nc">Nx</span><span class="o">.</span><span class="n">axis_size</span><span class="p" data-group-id="0331108351-10">(</span><span class="n">test_images</span><span class="p">,</span><span class="w"> </span><span class="ss">:images</span><span class="p" data-group-id="0331108351-10">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="0331108351-9">)</span><span class="p" data-group-id="0331108351-8">)</span><span class="w">
  </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">combined_input_output</span><span class="o">.</span><span class="p" data-group-id="0331108351-11">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">image_index</span><span class="p" data-group-id="0331108351-11">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">image_to_kino</span><span class="o">.</span><span class="p" data-group-id="0331108351-12">(</span><span class="p" data-group-id="0331108351-12">)</span><span class="w">
  </span><span class="nc">Kino.Frame</span><span class="o">.</span><span class="n">append</span><span class="p" data-group-id="0331108351-13">(</span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p" data-group-id="0331108351-13">)</span><span class="w">
  </span><span class="p" data-group-id="0331108351-14">{</span><span class="ss">:continue</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0331108351-14">}</span><span class="w">
</span><span class="k" data-group-id="0331108351-3">end</span><span class="w">

</span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="0331108351-15">(</span><span class="ss">:mean_squared_error</span><span class="p">,</span><span class="w"> </span><span class="nc">Polaris.Optimizers</span><span class="o">.</span><span class="n">adamw</span><span class="p" data-group-id="0331108351-16">(</span><span class="ss">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.001</span><span class="p" data-group-id="0331108351-16">)</span><span class="p" data-group-id="0331108351-15">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">handle</span><span class="p" data-group-id="0331108351-17">(</span><span class="ss">:iteration_completed</span><span class="p">,</span><span class="w"> </span><span class="n">render_example_handler</span><span class="p">,</span><span class="w"> </span><span class="ss">every</span><span class="p">:</span><span class="w"> </span><span class="mi">450</span><span class="p" data-group-id="0331108351-17">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">validate</span><span class="p" data-group-id="0331108351-18">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">test_data</span><span class="p" data-group-id="0331108351-18">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="0331108351-19">(</span><span class="n">train_data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0331108351-20">%{</span><span class="p" data-group-id="0331108351-20">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="0331108351-19">)</span><span class="w">

</span><span class="ss">:ok</span></code></pre><p>Awesome! We have a working denoising autoencoder that we can visualize getting better in 20 epochs!</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="credit_card_fraud.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Classifying fraudulent transactions
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="fashionmnist_autoencoder.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Training an Autoencoder on Fashion MNIST
        </span>
      </a>

  </div>
</div>
      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/axon/0.6.1" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/axon/0.6.1">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/axon/0.6.1/show/notebooks/generative/mnist_autoencoder_using_kino.livemd">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="Axon.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.31.1) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</main>
</div>

<!-- Render math with KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js" integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    });
  });
</script>

<!-- Render diagrams with Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.3/dist/mermaid.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    mermaid.initialize({ startOnLoad: false });
    let id = 0;
    for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
        graphEl.innerHTML = svgSource;
        bindListeners && bindListeners(graphEl);
        preEl.insertAdjacentElement("afterend", graphEl);
        preEl.remove();
      });
    }
  });
</script>

  </body>
</html>
