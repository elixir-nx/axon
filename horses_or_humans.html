<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.29.3">
    <meta name="project" content="Axon v0.6.0">

    <title>Classifying horses and humans â€” Axon v0.6.0</title>
    <link rel="stylesheet" href="dist/html-elixir-MB5C7R66.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-XRYTXUVD.js"></script>
    <script src="dist/sidebar_items-67B702C1.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-EHGDP2LQ.js"></script>


  </head>
  <body data-type="extras" class="page-livemd">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

      <a href="Axon.html">
        <img src="assets/logo.png" alt="Axon" class="sidebar-projectImage">
      </a>

    <div class="sidebar-projectDetails">
      <a href="Axon.html" class="sidebar-projectName" translate="no">
Axon
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.6.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="icon-action display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


    <a href="https://github.com/elixir-nx/axon/blob/v0.6.0/notebooks/vision/horses_or_humans.livemd#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>Classifying horses and humans</span>
</h1>

  <div class="livebook-badge-container">
    <a href="#" class="livebook-badge">
      <img src="https://livebook.dev/badge/v1/blue.svg" alt="Run in Livebook" width="150" />
    </a>
  </div>

<pre><code class="makeup elixir" translate="no"><span class="nc">Mix</span><span class="o">.</span><span class="n">install</span><span class="p" data-group-id="4188052047-1">(</span><span class="p" data-group-id="4188052047-2">[</span><span class="w">
  </span><span class="p" data-group-id="4188052047-3">{</span><span class="ss">:axon</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.0&quot;</span><span class="p" data-group-id="4188052047-3">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4188052047-4">{</span><span class="ss">:nx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.4.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">sparse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nx&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">override</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4188052047-4">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4188052047-5">{</span><span class="ss">:exla</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.4.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">sparse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;exla&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">override</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4188052047-5">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4188052047-6">{</span><span class="ss">:stb_image</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.5.2&quot;</span><span class="p" data-group-id="4188052047-6">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4188052047-7">{</span><span class="ss">:req</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.3.1&quot;</span><span class="p" data-group-id="4188052047-7">}</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="4188052047-8">{</span><span class="ss">:kino</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.7.0&quot;</span><span class="p" data-group-id="4188052047-8">}</span><span class="w">
</span><span class="p" data-group-id="4188052047-2">]</span><span class="p" data-group-id="4188052047-1">)</span><span class="w">

</span><span class="nc">Nx</span><span class="o">.</span><span class="n">global_default_backend</span><span class="p" data-group-id="4188052047-9">(</span><span class="nc">EXLA.Backend</span><span class="p" data-group-id="4188052047-9">)</span><span class="w">
</span><span class="nc">Nx.Defn</span><span class="o">.</span><span class="n">global_default_options</span><span class="p" data-group-id="4188052047-10">(</span><span class="ss">compiler</span><span class="p">:</span><span class="w"> </span><span class="nc">EXLA</span><span class="p" data-group-id="4188052047-10">)</span></code></pre><h2 id="introduction" class="section-heading">
  <a href="#introduction" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">introduction</p>
  </a>
  Introduction
</h2>
<p>In this notebook, we want to predict whether an image presents a horse or a human. To do this efficiently, we will build a Convolutional Neural Network (CNN) and compare the learning process with and without gradient centralization.</p><h2 id="loading-the-data" class="section-heading">
  <a href="#loading-the-data" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">loading-the-data</p>
  </a>
  Loading the data
</h2>
<p>We will be using the <a href="https://laurencemoroney.com/datasets.html#horses-or-humans-dataset">Horses or Humans Dataset</a>. The dataset is available as a ZIP with image files, we will download it using <code class="inline">req</code>. Conveniently, <code class="inline">req</code> will unzip the files for us, we just need to convert the filenames from strings.</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="4060254854-1">%{</span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="n">files</span><span class="p" data-group-id="4060254854-1">}</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Req</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="4060254854-2">(</span><span class="s">&quot;https://storage.googleapis.com/laurencemoroney-blog.appspot.com/horse-or-human.zip&quot;</span><span class="p" data-group-id="4060254854-2">)</span><span class="w">

</span><span class="n">files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="4060254854-3">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="4060254854-3">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4060254854-4">{</span><span class="nc">List</span><span class="o">.</span><span class="n">to_string</span><span class="p" data-group-id="4060254854-5">(</span><span class="n">name</span><span class="p" data-group-id="4060254854-5">)</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="4060254854-4">}</span></code></pre><h3 id="note-on-batching" class="section-heading">
  <a href="#note-on-batching" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">note-on-batching</p>
  </a>
  Note on batching
</h3>
<p>We need to know how many images to include in a batch. A batch is a group of images to load into the GPU at a time. If the batch size is too big for your GPU, it will run out of memory, in such case you can reduce the batch size. It is generally optimal to utilize almost all of the GPU memory during training. It will take more time to train with a lower batch size.</p><pre><code class="makeup elixir" translate="no"><span class="n">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="w">
</span><span class="n">batches_per_epoch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">div</span><span class="p" data-group-id="4932535202-1">(</span><span class="n">length</span><span class="p" data-group-id="4932535202-2">(</span><span class="n">files</span><span class="p" data-group-id="4932535202-2">)</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p" data-group-id="4932535202-1">)</span></code></pre><h2 id="a-look-at-the-data" class="section-heading">
  <a href="#a-look-at-the-data" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">a-look-at-the-data</p>
  </a>
  A look at the data
</h2>
<p>We'll have a really quick look at our data. Let's see what we are dealing with:</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="9523395333-1">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="9523395333-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">random</span><span class="p" data-group-id="9523395333-2">(</span><span class="n">files</span><span class="p" data-group-id="9523395333-2">)</span><span class="w">
</span><span class="nc">Kino.Markdown</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="9523395333-3">(</span><span class="n">name</span><span class="p" data-group-id="9523395333-3">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="9523395333-4">(</span><span class="p" data-group-id="9523395333-4">)</span><span class="w">
</span><span class="nc">Kino.Image</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="9523395333-5">(</span><span class="n">binary</span><span class="p">,</span><span class="w"> </span><span class="ss">:png</span><span class="p" data-group-id="9523395333-5">)</span></code></pre><p>Reevaluate the cell a couple times to view different images. Note that the file names are either <code class="inline">horse[N]-[M].png</code> or <code class="inline">human[N]-[M].png</code>, so we can derive the expected class from that.</p><p>While we are at it, look at this beautiful animation:</p><pre><code class="makeup elixir" translate="no"><span class="n">names_to_animate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2830898827-1">[</span><span class="s">&quot;horse01&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;horse05&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;human01&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;human05&quot;</span><span class="p" data-group-id="2830898827-1">]</span><span class="w">

</span><span class="n">images_to_animate</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="2830898827-2">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="2830898827-2">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">any?</span><span class="p" data-group-id="2830898827-3">(</span><span class="n">names_to_animate</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nc">String</span><span class="o">.</span><span class="n">contains?</span><span class="p" data-group-id="2830898827-4">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="2830898827-4">)</span><span class="p" data-group-id="2830898827-3">)</span><span class="w"> </span><span class="k" data-group-id="2830898827-5">do</span><span class="w">
    </span><span class="nc">Kino.Image</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="2830898827-6">(</span><span class="n">binary</span><span class="p">,</span><span class="w"> </span><span class="ss">:png</span><span class="p" data-group-id="2830898827-6">)</span><span class="w">
  </span><span class="k" data-group-id="2830898827-5">end</span><span class="w">

</span><span class="nc">Kino</span><span class="o">.</span><span class="n">animate</span><span class="p" data-group-id="2830898827-7">(</span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="n">images_to_animate</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="2830898827-8">fn</span><span class="w">
  </span><span class="c">_i</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2830898827-9">[</span><span class="n">image</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">images</span><span class="p" data-group-id="2830898827-9">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2830898827-10">{</span><span class="ss">:cont</span><span class="p">,</span><span class="w"> </span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">images</span><span class="p" data-group-id="2830898827-10">}</span><span class="w">
  </span><span class="c">_i</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2830898827-11">[</span><span class="p" data-group-id="2830898827-11">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:halt</span><span class="w">
</span><span class="k" data-group-id="2830898827-8">end</span><span class="p" data-group-id="2830898827-7">)</span></code></pre><p>How many images are there?</p><pre><code class="makeup elixir" translate="no"><span class="n">length</span><span class="p" data-group-id="9945857968-1">(</span><span class="n">files</span><span class="p" data-group-id="9945857968-1">)</span></code></pre><p>How many images will not be used for training? The remainder of the integer division will be ignored.</p><pre><code class="makeup elixir" translate="no"><span class="n">files</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="n">length</span><span class="p" data-group-id="6677134565-1">(</span><span class="p" data-group-id="6677134565-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="n">rem</span><span class="p" data-group-id="6677134565-2">(</span><span class="n">batch_size</span><span class="p" data-group-id="6677134565-2">)</span></code></pre><h2 id="data-processing" class="section-heading">
  <a href="#data-processing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">data-processing</p>
  </a>
  Data processing
</h2>
<p>First, we need to preprocess the data for our CNN. At the beginning of the process, we chunk images into batches. Then, we use the <code class="inline">parse_file/1</code> function to load images and label them accurately. Finally, we &quot;augment&quot; the input, which means that we normalize data and flip the images along one of the axes. The last procedure helps a neural network to make predictions regardless of the orientation of the image.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">HorsesHumans.DataProcessing</span><span class="w"> </span><span class="k" data-group-id="4771747455-1">do</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Nx.Defn</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">data_stream</span><span class="p" data-group-id="4771747455-2">(</span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p" data-group-id="4771747455-2">)</span><span class="w"> </span><span class="k" data-group-id="4771747455-3">do</span><span class="w">
    </span><span class="n">files</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">shuffle</span><span class="p" data-group-id="4771747455-4">(</span><span class="p" data-group-id="4771747455-4">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">chunk_every</span><span class="p" data-group-id="4771747455-5">(</span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p">,</span><span class="w"> </span><span class="ss">:discard</span><span class="p" data-group-id="4771747455-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">async_stream</span><span class="p" data-group-id="4771747455-6">(</span><span class="w">
      </span><span class="k" data-group-id="4771747455-7">fn</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="4771747455-8">{</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p" data-group-id="4771747455-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="4771747455-9">(</span><span class="o">&amp;</span><span class="n">parse_file</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="4771747455-9">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">unzip</span><span class="p" data-group-id="4771747455-10">(</span><span class="p" data-group-id="4771747455-10">)</span><span class="w">
        </span><span class="p" data-group-id="4771747455-11">{</span><span class="nc">Nx</span><span class="o">.</span><span class="n">stack</span><span class="p" data-group-id="4771747455-12">(</span><span class="n">images</span><span class="p" data-group-id="4771747455-12">)</span><span class="p">,</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">stack</span><span class="p" data-group-id="4771747455-13">(</span><span class="n">labels</span><span class="p" data-group-id="4771747455-13">)</span><span class="p" data-group-id="4771747455-11">}</span><span class="w">
      </span><span class="k" data-group-id="4771747455-7">end</span><span class="p">,</span><span class="w">
      </span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="ss">:infinity</span><span class="w">
    </span><span class="p" data-group-id="4771747455-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="4771747455-14">(</span><span class="k" data-group-id="4771747455-15">fn</span><span class="w"> </span><span class="p" data-group-id="4771747455-16">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4771747455-17">{</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p" data-group-id="4771747455-17">}</span><span class="p" data-group-id="4771747455-16">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="4771747455-18">{</span><span class="n">augment</span><span class="p" data-group-id="4771747455-19">(</span><span class="n">images</span><span class="p" data-group-id="4771747455-19">)</span><span class="p">,</span><span class="w"> </span><span class="n">labels</span><span class="p" data-group-id="4771747455-18">}</span><span class="w"> </span><span class="k" data-group-id="4771747455-15">end</span><span class="p" data-group-id="4771747455-14">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">cycle</span><span class="p" data-group-id="4771747455-20">(</span><span class="p" data-group-id="4771747455-20">)</span><span class="w">
  </span><span class="k" data-group-id="4771747455-3">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">parse_file</span><span class="p" data-group-id="4771747455-21">(</span><span class="p" data-group-id="4771747455-22">{</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="4771747455-22">}</span><span class="p" data-group-id="4771747455-21">)</span><span class="w"> </span><span class="k" data-group-id="4771747455-23">do</span><span class="w">
    </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">starts_with?</span><span class="p" data-group-id="4771747455-24">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;horses/&quot;</span><span class="p" data-group-id="4771747455-24">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">tensor</span><span class="p" data-group-id="4771747455-25">(</span><span class="p" data-group-id="4771747455-26">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="4771747455-26">]</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4771747455-27">{</span><span class="ss">:u</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="4771747455-27">}</span><span class="p" data-group-id="4771747455-25">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">else</span><span class="p">:</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">tensor</span><span class="p" data-group-id="4771747455-28">(</span><span class="p" data-group-id="4771747455-29">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="4771747455-29">]</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4771747455-30">{</span><span class="ss">:u</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p" data-group-id="4771747455-30">}</span><span class="p" data-group-id="4771747455-28">)</span><span class="w">

    </span><span class="n">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binary</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">read_binary!</span><span class="p" data-group-id="4771747455-31">(</span><span class="p" data-group-id="4771747455-31">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">to_nx</span><span class="p" data-group-id="4771747455-32">(</span><span class="p" data-group-id="4771747455-32">)</span><span class="w">

    </span><span class="p" data-group-id="4771747455-33">{</span><span class="n">image</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p" data-group-id="4771747455-33">}</span><span class="w">
  </span><span class="k" data-group-id="4771747455-23">end</span><span class="w">

  </span><span class="kd">defnp</span><span class="w"> </span><span class="nf">augment</span><span class="p" data-group-id="4771747455-34">(</span><span class="n">images</span><span class="p" data-group-id="4771747455-34">)</span><span class="w"> </span><span class="k" data-group-id="4771747455-35">do</span><span class="w">
    </span><span class="c1"># Normalize</span><span class="w">
    </span><span class="n">images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">255.0</span><span class="w">

    </span><span class="c1"># Optional vertical/horizontal flip</span><span class="w">
    </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">random_uniform</span><span class="p" data-group-id="4771747455-36">(</span><span class="p" data-group-id="4771747455-37">{</span><span class="p" data-group-id="4771747455-37">}</span><span class="p" data-group-id="4771747455-36">)</span><span class="w">

    </span><span class="k">cond</span><span class="w"> </span><span class="k" data-group-id="4771747455-38">do</span><span class="w">
      </span><span class="n">u</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.25</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">images</span><span class="w">
      </span><span class="n">u</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reverse</span><span class="p" data-group-id="4771747455-39">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4771747455-40">[</span><span class="mi">2</span><span class="p" data-group-id="4771747455-40">]</span><span class="p" data-group-id="4771747455-39">)</span><span class="w">
      </span><span class="n">u</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.75</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reverse</span><span class="p" data-group-id="4771747455-41">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4771747455-42">[</span><span class="mi">3</span><span class="p" data-group-id="4771747455-42">]</span><span class="p" data-group-id="4771747455-41">)</span><span class="w">
      </span><span class="no">true</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">reverse</span><span class="p" data-group-id="4771747455-43">(</span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="ss">axes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4771747455-44">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="4771747455-44">]</span><span class="p" data-group-id="4771747455-43">)</span><span class="w">
    </span><span class="k" data-group-id="4771747455-38">end</span><span class="w">
  </span><span class="k" data-group-id="4771747455-35">end</span><span class="w">
</span><span class="k" data-group-id="4771747455-1">end</span></code></pre><h2 id="building-the-model" class="section-heading">
  <a href="#building-the-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">building-the-model</p>
  </a>
  Building the model
</h2>
<p>The next step is creating our model. In this notebook, we choose the classic Convolutional Neural Network architecture. Let's dive in to the core components of a CNN.</p><p><a href="Axon.html#conv/3"><code class="inline">Axon.conv/3</code></a> adds a convolutional layer, which is at the core of a CNN. A convolutional layer applies a filter function throughout the image, sliding a window with shape <code class="inline">:kernel_size</code>. As opposed to dense layers, a convolutional layer exploits weight sharing to better model data where locality matters. This feature is a natural fit for images.</p><table><thead><tr><th style="text-align: center;"><img src="https://miroslawmamczur.pl/wp-content/uploads/2021/03/06.gif" alt=""/></th></tr></thead><tbody><tr><td style="text-align: center;">Figure 1: A step-by-step visualization of a convolution layer for <code class="inline">kernel_size: {3, 3}</code></td></tr></tbody></table><p><a href="Axon.html#max_pool/2"><code class="inline">Axon.max_pool/2</code></a> adds a downscaling operation that takes the maximum value from a subtensor according to <code class="inline">:kernel_size</code>.</p><table><thead><tr><th style="text-align: center;"><img src="https://production-media.paperswithcode.com/methods/MaxpoolSample2.png" alt=""/></th></tr></thead><tbody><tr><td style="text-align: center;">Figure 2: Max pooling operation for <code class="inline">kernel_size: {2, 2}</code></td></tr></tbody></table><p><a href="Axon.html#dropout/2"><code class="inline">Axon.dropout/2</code></a> and <a href="Axon.html#spatial_dropout/2"><code class="inline">Axon.spatial_dropout/2</code></a> add dropout layers which prevent a neural network from overfitting. Standard dropout drops a given rate of randomly chosen neurons during the training process. On the other hand, spatial dropout gets rid of whole feature maps. The graphical difference between dropout and spatial dropout is presented in a picture below.</p><table><thead><tr><th style="text-align: center;"><img src="https://miro.medium.com/max/1400/1*KkqxjvXTIV_b365B41ltfg.png" alt=""/></th></tr></thead><tbody><tr><td style="text-align: center;">Figure 3: The difference between standard dropout and spatial dropout</td></tr></tbody></table><p>Knowing the relevant building blocks, let's build our network! It will have a convolutional part, composed of convolutional and pooling layers, this part should capture the spatial features of an image. Then at the end, we will add a dense layer with 512 neurons fed with all the spatial features, and a final two-neuron layer for as our classification output.</p><pre><code class="makeup elixir" translate="no"><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="nc">Axon</span><span class="o">.</span><span class="n">input</span><span class="p" data-group-id="4807651804-1">(</span><span class="s">&quot;input&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">shape</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-2">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="4807651804-2">}</span><span class="p" data-group-id="4807651804-1">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">conv</span><span class="p" data-group-id="4807651804-3">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-4">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="4807651804-4">}</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4807651804-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">max_pool</span><span class="p" data-group-id="4807651804-5">(</span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-6">{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="4807651804-6">}</span><span class="p" data-group-id="4807651804-5">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">conv</span><span class="p" data-group-id="4807651804-7">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-8">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="4807651804-8">}</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4807651804-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">spatial_dropout</span><span class="p" data-group-id="4807651804-9">(</span><span class="ss">rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p" data-group-id="4807651804-9">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">max_pool</span><span class="p" data-group-id="4807651804-10">(</span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-11">{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="4807651804-11">}</span><span class="p" data-group-id="4807651804-10">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">conv</span><span class="p" data-group-id="4807651804-12">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-13">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="4807651804-13">}</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4807651804-12">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">spatial_dropout</span><span class="p" data-group-id="4807651804-14">(</span><span class="ss">rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p" data-group-id="4807651804-14">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">max_pool</span><span class="p" data-group-id="4807651804-15">(</span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-16">{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="4807651804-16">}</span><span class="p" data-group-id="4807651804-15">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">conv</span><span class="p" data-group-id="4807651804-17">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-18">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="4807651804-18">}</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4807651804-17">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">max_pool</span><span class="p" data-group-id="4807651804-19">(</span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-20">{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="4807651804-20">}</span><span class="p" data-group-id="4807651804-19">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">conv</span><span class="p" data-group-id="4807651804-21">(</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-22">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="4807651804-22">}</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4807651804-21">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">max_pool</span><span class="p" data-group-id="4807651804-23">(</span><span class="ss">kernel_size</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4807651804-24">{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="4807651804-24">}</span><span class="p" data-group-id="4807651804-23">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">flatten</span><span class="p" data-group-id="4807651804-25">(</span><span class="p" data-group-id="4807651804-25">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dropout</span><span class="p" data-group-id="4807651804-26">(</span><span class="ss">rate</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p" data-group-id="4807651804-26">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4807651804-27">(</span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:relu</span><span class="p" data-group-id="4807651804-27">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon</span><span class="o">.</span><span class="n">dense</span><span class="p" data-group-id="4807651804-28">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">activation</span><span class="p">:</span><span class="w"> </span><span class="ss">:softmax</span><span class="p" data-group-id="4807651804-28">)</span></code></pre><h2 id="training-the-model" class="section-heading">
  <a href="#training-the-model" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">training-the-model</p>
  </a>
  Training the model
</h2>
<p>It's time to train our model. We specify the loss, optimizer and choose accuracy as our metric. We also set <code class="inline">log: 1</code> to frequently update the training progress. We manually specify the number of iterations, such that each epoch goes through all of the baches once.</p><pre><code class="makeup elixir" translate="no"><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">HorsesHumans.DataProcessing</span><span class="o">.</span><span class="n">data_stream</span><span class="p" data-group-id="6997603988-1">(</span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p" data-group-id="6997603988-1">)</span><span class="w">

</span><span class="n">optimizer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Polaris.Optimizers</span><span class="o">.</span><span class="n">adam</span><span class="p" data-group-id="6997603988-2">(</span><span class="ss">learning_rate</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0e-4</span><span class="p" data-group-id="6997603988-2">)</span><span class="w">

</span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">model</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="6997603988-3">(</span><span class="ss">:categorical_cross_entropy</span><span class="p">,</span><span class="w"> </span><span class="n">optimizer</span><span class="p">,</span><span class="w"> </span><span class="ss">:identity</span><span class="p">,</span><span class="w"> </span><span class="ss">log</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="6997603988-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="6997603988-4">(</span><span class="ss">:accuracy</span><span class="p" data-group-id="6997603988-4">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="6997603988-5">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6997603988-6">%{</span><span class="p" data-group-id="6997603988-6">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">iterations</span><span class="p">:</span><span class="w"> </span><span class="n">batches_per_epoch</span><span class="p" data-group-id="6997603988-5">)</span></code></pre><h2 id="extra-gradient-centralization" class="section-heading">
  <a href="#extra-gradient-centralization" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">extra-gradient-centralization</p>
  </a>
  Extra: gradient centralization
</h2>
<p>We can improve the training by applying gradient centralization. It is a technique with a similar purpose to batch normalization. For each loss gradient, we subtract a mean value to have a gradient with mean equal to zero. This process prevents gradients from exploding.</p><pre><code class="makeup elixir" translate="no"><span class="n">centralized_optimizer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Polaris.Updates</span><span class="o">.</span><span class="n">compose</span><span class="p" data-group-id="6350412012-1">(</span><span class="nc">Polaris.Updates</span><span class="o">.</span><span class="n">centralize</span><span class="p" data-group-id="6350412012-2">(</span><span class="p" data-group-id="6350412012-2">)</span><span class="p">,</span><span class="w"> </span><span class="n">optimizer</span><span class="p" data-group-id="6350412012-1">)</span><span class="w">

</span><span class="n">model</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">trainer</span><span class="p" data-group-id="6350412012-3">(</span><span class="ss">:categorical_cross_entropy</span><span class="p">,</span><span class="w"> </span><span class="n">centralized_optimizer</span><span class="p">,</span><span class="w"> </span><span class="ss">:identity</span><span class="p">,</span><span class="w"> </span><span class="ss">log</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="6350412012-3">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">metric</span><span class="p" data-group-id="6350412012-4">(</span><span class="ss">:accuracy</span><span class="p" data-group-id="6350412012-4">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Axon.Loop</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="6350412012-5">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6350412012-6">%{</span><span class="p" data-group-id="6350412012-6">}</span><span class="p">,</span><span class="w"> </span><span class="ss">epochs</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">iterations</span><span class="p">:</span><span class="w"> </span><span class="n">batches_per_epoch</span><span class="p" data-group-id="6350412012-5">)</span></code></pre><h2 id="inference" class="section-heading">
  <a href="#inference" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">inference</p>
  </a>
  Inference
</h2>
<p>We can now use our trained model, let's try a couple examples.</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="6243584652-1">{</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="6243584652-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">random</span><span class="p" data-group-id="6243584652-2">(</span><span class="n">files</span><span class="p" data-group-id="6243584652-2">)</span><span class="w">
</span><span class="nc">Kino.Markdown</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="6243584652-3">(</span><span class="n">name</span><span class="p" data-group-id="6243584652-3">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="6243584652-4">(</span><span class="p" data-group-id="6243584652-4">)</span><span class="w">
</span><span class="nc">Kino.Image</span><span class="o">.</span><span class="n">new</span><span class="p" data-group-id="6243584652-5">(</span><span class="n">binary</span><span class="p">,</span><span class="w"> </span><span class="ss">:png</span><span class="p" data-group-id="6243584652-5">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Kino</span><span class="o">.</span><span class="n">render</span><span class="p" data-group-id="6243584652-6">(</span><span class="p" data-group-id="6243584652-6">)</span><span class="w">

</span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w">
  </span><span class="n">binary</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">read_binary!</span><span class="p" data-group-id="6243584652-7">(</span><span class="p" data-group-id="6243584652-7">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">StbImage</span><span class="o">.</span><span class="n">to_nx</span><span class="p" data-group-id="6243584652-8">(</span><span class="p" data-group-id="6243584652-8">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">new_axis</span><span class="p" data-group-id="6243584652-9">(</span><span class="mi">0</span><span class="p" data-group-id="6243584652-9">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Nx</span><span class="o">.</span><span class="n">divide</span><span class="p" data-group-id="6243584652-10">(</span><span class="mf">255.0</span><span class="p" data-group-id="6243584652-10">)</span><span class="w">

</span><span class="nc">Axon</span><span class="o">.</span><span class="n">predict</span><span class="p" data-group-id="6243584652-11">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p" data-group-id="6243584652-11">)</span></code></pre><p><em>Note: the model output refers to the probability that the image presents a horse and a human respectively.</em></p><p>The website from where we loaded the dataset also includes a validation set, in case you want to experiment further!</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="mnist.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
Classifying handwritten digits
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="lstm_generation.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page â†’
        </span>
        <span class="title">
Generating text with LSTM
        </span>
      </a>

  </div>
</div>
      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/axon/0.6.0" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/axon/0.6.0">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/axon/0.6.0/show/notebooks/vision/horses_or_humans.livemd">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

              <a href="Axon.epub" title="ePub version">
                Download ePub version
              </a>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.29.3) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>

<!-- Render math with KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css" integrity="sha384-t5CR+zwDAROtph0PXGte6ia8heboACF9R5l/DiY+WZ3P2lxNgvJkQk5n7GPvLMYw" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" integrity="sha384-FaFLTlohFghEIZkw6VGwmf9ISTubWAVYW8tG8+w2LAIftJEULZABrF9PPFv+tVkH" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js" integrity="sha384-bHBqxz8fokvgoJ/sc17HODNxa42TlaEhB+w8ZJXTc2nZf1VgEaFZeZvT4Mznfz0v" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    });
  });
</script>

<!-- Render diagrams with Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.3/dist/mermaid.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    mermaid.initialize({ startOnLoad: false });
    let id = 0;
    for (const codeEl of document.querySelectorAll("pre code.mermaid")) {
      const preEl = codeEl.parentElement;
      const graphDefinition = codeEl.textContent;
      const graphEl = document.createElement("div");
      const graphId = "mermaid-graph-" + id++;
      mermaid.render(graphId, graphDefinition, function (svgSource, bindListeners) {
        graphEl.innerHTML = svgSource;
        bindListeners && bindListeners(graphEl);
        preEl.insertAdjacentElement("afterend", graphEl);
        preEl.remove();
      });
    }
  });
</script>

  </body>
</html>
